/**
 * skylark-io-files - The skylark file system library
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["skylark-langx-funcs/defer","skylark-langx-binary/buffer","skylark-langx-paths","./files","./error-codes","./file-error","./file-flag","./stats"],function(i,y,e,t,h,u,c,n){"use strict";let o=function(t,e){return t};function d(t,e){if("function"!=typeof t)throw new Error("Callback must be a function.");const r=o(t,e);switch(e){case 1:return function(t){i(function(){return r(t)})};case 2:return function(t,e){i(function(){return r(t,e)})};case 3:return function(t,e,n){i(function(){return r(t,e,n)})};default:throw new Error("Invalid invocation of wrapCb.")}}function a(t){if(t)return t;throw new u(h.EIO,"Initialize BrowserFS with a file system using BrowserFS.initialize(filesystem)")}function s(t,e){switch(typeof t){case"number":return t;case"string":var n=parseInt(t,8);return isNaN(n)?e:n;default:return e}}function l(t){if(t instanceof Date)return t;if("number"==typeof t)return new Date(1e3*t);throw new u(h.EINVAL,"Invalid time.")}function f(t){if(0<=t.indexOf("\0"))throw new u(h.EINVAL,"Path must be a string without null bytes.");if(""===t)throw new u(h.EINVAL,"Path must not be empty.");return e.resolve(t)}function w(t,e,n,r){switch(null===t?"null":typeof t){case"object":return{encoding:void 0!==t.encoding?t.encoding:e,flag:void 0!==t.flag?t.flag:n,mode:s(t.mode,r)};case"string":return{encoding:t,flag:n,mode:r};case"null":case"undefined":case"function":return{encoding:e,flag:n,mode:r};default:throw new TypeError(`"options" must be a string or an object, got ${typeof t} instead.`)}}function p(){}return t.FileSystem=class{constructor(){this.F_OK=0,this.R_OK=4,this.W_OK=2,this.X_OK=1,this.root=null,this.fdMap={},this.nextFd=100}initialize(t){if(t.constructor.isAvailable())return this.root=t;throw new u(h.EINVAL,"Tried to instantiate BrowserFS with an unavailable file system.")}_toUnixTimestamp(t){if("number"==typeof t)return t;if(t instanceof Date)return t.getTime()/1e3;throw new Error("Cannot parse time: "+t)}getRootFS(){return this.root||null}rename(t,e,n=p){n=d(n,1);try{a(this.root).rename(f(t),f(e),n)}catch(t){n(t)}}renameSync(t,e){a(this.root).renameSync(f(t),f(e))}exists(t,e=p){e=d(e,1);try{return a(this.root).exists(f(t),e)}catch(t){return e(!1)}}existsSync(t){try{return a(this.root).existsSync(f(t))}catch(t){return!1}}stat(t,e=p){e=d(e,2);try{return a(this.root).stat(f(t),!1,e)}catch(t){return e(t)}}statSync(t){return a(this.root).statSync(f(t),!1)}lstat(t,e=p){e=d(e,2);try{return a(this.root).stat(f(t),!0,e)}catch(t){return e(t)}}lstatSync(t){return a(this.root).statSync(f(t),!0)}truncate(t,e=0,n=p){let r=0;"function"==typeof e?n=e:"number"==typeof e&&(r=e);e=d(n,1);try{if(r<0)throw new u(h.EINVAL);return a(this.root).truncate(f(t),r,e)}catch(t){return e(t)}}truncateSync(t,e=0){if(e<0)throw new u(h.EINVAL);return a(this.root).truncateSync(f(t),e)}unlink(t,e=p){e=d(e,1);try{return a(this.root).unlink(f(t),e)}catch(t){return e(t)}}unlinkSync(t){return a(this.root).unlinkSync(f(t))}open(t,e,n,r=p){var i=s(n,420);const o=d(r="function"==typeof n?n:r,2);try{a(this.root).open(f(t),c.getFileFlag(e),i,(t,e)=>{e?o(t,this.getFdForFile(e)):o(t)})}catch(t){o(t)}}openSync(t,e,n=420){return this.getFdForFile(a(this.root).openSync(f(t),c.getFileFlag(e),s(n,420)))}readFile(t,e={},n=p){var r=w(e,null,"r",null),e=d(n="function"==typeof e?e:n,2);try{var i=c.getFileFlag(r.flag);return i.isReadable()?a(this.root).readFile(f(t),r.encoding,i,e):e(new u(h.EINVAL,"Flag passed to readFile must allow for reading."))}catch(t){return e(t)}}readFileSync(t,e={}){var e=w(e,null,"r",null),n=c.getFileFlag(e.flag);if(n.isReadable())return a(this.root).readFileSync(f(t),e.encoding,n);throw new u(h.EINVAL,"Flag passed to readFile must allow for reading.")}writeFile(t,e,n={},r=p){var i=w(n,"utf8","w",420),n=d(r="function"==typeof n?n:r,1);try{var o=c.getFileFlag(i.flag);return o.isWriteable()?a(this.root).writeFile(f(t),e,i.encoding,o,i.mode,n):n(new u(h.EINVAL,"Flag passed to writeFile must allow for writing."))}catch(t){return n(t)}}writeFileSync(t,e,n){var n=w(n,"utf8","w",420),r=c.getFileFlag(n.flag);if(r.isWriteable())return a(this.root).writeFileSync(f(t),e,n.encoding,r,n.mode);throw new u(h.EINVAL,"Flag passed to writeFile must allow for writing.")}appendFile(t,e,n,r=p){var i=w(n,"utf8","a",420),n=d(r="function"==typeof n?n:r,1);try{var o=c.getFileFlag(i.flag);if(!o.isAppendable())return n(new u(h.EINVAL,"Flag passed to appendFile must allow for appending."));a(this.root).appendFile(f(t),e,i.encoding,o,i.mode,n)}catch(t){n(t)}}appendFileSync(t,e,n){var n=w(n,"utf8","a",420),r=c.getFileFlag(n.flag);if(r.isAppendable())return a(this.root).appendFileSync(f(t),e,n.encoding,r,n.mode);throw new u(h.EINVAL,"Flag passed to appendFile must allow for appending.")}fstat(t,e=p){e=d(e,2);try{this.fd2file(t).stat(e)}catch(t){e(t)}}fstatSync(t){return this.fd2file(t).statSync()}close(e,t=p){const n=d(t,1);try{this.fd2file(e).close(t=>{t||this.closeFd(e),n(t)})}catch(t){n(t)}}closeSync(t){this.fd2file(t).closeSync(),this.closeFd(t)}ftruncate(t,e,n=p){var r="number"==typeof e?e:0,e=d(n="function"==typeof e?e:n,1);try{var i=this.fd2file(t);if(r<0)throw new u(h.EINVAL);i.truncate(r,e)}catch(t){e(t)}}ftruncateSync(t,e=0){t=this.fd2file(t);if(e<0)throw new u(h.EINVAL);t.truncateSync(e)}fsync(t,e=p){e=d(e,1);try{this.fd2file(t).sync(e)}catch(t){e(t)}}fsyncSync(t){this.fd2file(t).syncSync()}fdatasync(t,e=p){e=d(e,1);try{this.fd2file(t).datasync(e)}catch(t){e(t)}}fdatasyncSync(t){this.fd2file(t).datasyncSync()}write(t,e,n,r,i,o=p){let c,a,s,l=null;if("string"==typeof e){let t="utf8";switch(typeof n){case"function":o=n;break;case"number":l=n,t="string"==typeof r?r:"utf8",o="function"==typeof i?i:o;break;default:return(o="function"==typeof r?r:"function"==typeof i?i:o)(new u(h.EINVAL,"Invalid arguments."))}c=y.from(e,t),a=0,s=c.length}else c=e,a=n,s=r,l="number"==typeof i?i:null,o="function"==typeof i?i:o;e=d(o,3);try{var f=this.fd2file(t);void 0!==l&&null!==l||(l=f.getPos()),f.write(c,a,s,l,e)}catch(t){e(t)}}writeSync(t,e,n,r,i){let o,c=0,a,s;"string"==typeof e?(s="number"==typeof n?n:null,c=0,o=y.from(e,"string"==typeof r?r:"utf8"),a=o.length):(o=e,c=n,a=r,s="number"==typeof i?i:null);e=this.fd2file(t);return void 0!==s&&null!==s||(s=e.getPos()),e.writeSync(o,c,a,s)}read(t,e,n,r,i,o=p){let c,a,s,l,f;if("number"==typeof e){s=e,c=n;const u=r;o="function"==typeof i?i:o,a=0,l=y.alloc(s),f=d((t,e,n)=>{if(t)return o(t);o(t,n.toString(u),e)},3)}else l=e,a=n,s=r,c=i,f=d(o,3);try{var h=this.fd2file(t);void 0!==c&&null!==c||(c=h.getPos()),h.read(l,a,s,c,f)}catch(t){f(t)}}readSync(t,e,n,r,i){let o=!1,c,a,s,l,f="utf8";"number"==typeof e?(s=e,l=n,f=r,a=0,c=y.alloc(s),o=!0):(c=e,a=n,s=r,l=i);e=this.fd2file(t),void 0!==l&&null!==l||(l=e.getPos()),n=e.readSync(c,a,s,l);return o?[c.toString(f),n]:n}fchown(t,e,n,r=p){r=d(r,1);try{this.fd2file(t).chown(e,n,r)}catch(t){r(t)}}fchownSync(t,e,n){this.fd2file(t).chownSync(e,n)}fchmod(t,e,n){n=d(n,1);try{var r="string"==typeof e?parseInt(e,8):e;this.fd2file(t).chmod(r,n)}catch(t){n(t)}}fchmodSync(t,e){e="string"==typeof e?parseInt(e,8):e;this.fd2file(t).chmodSync(e)}futimes(t,e,n,r=p){r=d(r,1);try{var i=this.fd2file(t);"number"==typeof e&&(e=new Date(1e3*e)),"number"==typeof n&&(n=new Date(1e3*n)),i.utimes(e,n,r)}catch(t){r(t)}}futimesSync(t,e,n){this.fd2file(t).utimesSync(l(e),l(n))}rmdir(t,e=p){e=d(e,1);try{t=f(t),a(this.root).rmdir(t,e)}catch(t){e(t)}}rmdirSync(t){return t=f(t),a(this.root).rmdirSync(t)}mkdir(t,e,n=p){"function"==typeof e&&(n=e,e=511);n=d(n,1);try{t=f(t),a(this.root).mkdir(t,e,n)}catch(t){n(t)}}mkdirSync(t,e){a(this.root).mkdirSync(f(t),s(e,511))}readdir(t,e=p){e=d(e,2);try{t=f(t),a(this.root).readdir(t,e)}catch(t){e(t)}}readdirSync(t){return t=f(t),a(this.root).readdirSync(t)}link(t,e,n=p){n=d(n,1);try{t=f(t),e=f(e),a(this.root).link(t,e,n)}catch(t){n(t)}}linkSync(t,e){return t=f(t),e=f(e),a(this.root).linkSync(t,e)}symlink(t,e,n,r=p){var i="string"==typeof n?n:"file",n=d(r="function"==typeof n?n:r,1);try{if("file"!==i&&"dir"!==i)return n(new u(h.EINVAL,"Invalid type: "+i));t=f(t),e=f(e),a(this.root).symlink(t,e,i,n)}catch(t){n(t)}}symlinkSync(t,e,n){if(n){if("file"!==n&&"dir"!==n)throw new u(h.EINVAL,"Invalid type: "+n)}else n="file";return t=f(t),e=f(e),a(this.root).symlinkSync(t,e,n)}readlink(t,e=p){e=d(e,2);try{t=f(t),a(this.root).readlink(t,e)}catch(t){e(t)}}readlinkSync(t){return t=f(t),a(this.root).readlinkSync(t)}chown(t,e,n,r=p){r=d(r,1);try{t=f(t),a(this.root).chown(t,!1,e,n,r)}catch(t){r(t)}}chownSync(t,e,n){t=f(t),a(this.root).chownSync(t,!1,e,n)}lchown(t,e,n,r=p){r=d(r,1);try{t=f(t),a(this.root).chown(t,!0,e,n,r)}catch(t){r(t)}}lchownSync(t,e,n){t=f(t),a(this.root).chownSync(t,!0,e,n)}chmod(t,e,n=p){n=d(n,1);try{var r=s(e,-1);if(r<0)throw new u(h.EINVAL,"Invalid mode.");a(this.root).chmod(f(t),!1,r,n)}catch(t){n(t)}}chmodSync(t,e){e=s(e,-1);if(e<0)throw new u(h.EINVAL,"Invalid mode.");t=f(t),a(this.root).chmodSync(t,!1,e)}lchmod(t,e,n=p){n=d(n,1);try{var r=s(e,-1);if(r<0)throw new u(h.EINVAL,"Invalid mode.");a(this.root).chmod(f(t),!0,r,n)}catch(t){n(t)}}lchmodSync(t,e){e=s(e,-1);if(e<1)throw new u(h.EINVAL,"Invalid mode.");a(this.root).chmodSync(f(t),!0,e)}utimes(t,e,n,r=p){r=d(r,1);try{a(this.root).utimes(f(t),l(e),l(n),r)}catch(t){r(t)}}utimesSync(t,e,n){a(this.root).utimesSync(f(t),l(e),l(n))}realpath(t,e,n=0){var r="object"==typeof e?e:{},e=d("function"==typeof e?e:p,2);try{t=f(t),a(this.root).realpath(t,r,e)}catch(t){e(t)}}realpathSync(t,e={}){return t=f(t),a(this.root).realpathSync(t,e)}watchFile(t,e,n=0){throw new u(h.ENOTSUP)}unwatchFile(t,e=0){throw new u(h.ENOTSUP)}watch(t,e,n=0){throw new u(h.ENOTSUP)}access(t,e,n=0){throw new u(h.ENOTSUP)}accessSync(t,e){throw new u(h.ENOTSUP)}createReadStream(t,e){throw new u(h.ENOTSUP)}createWriteStream(t,e){throw new u(h.ENOTSUP)}wrapCallbacks(t){o=t}getFdForFile(t){var e=this.nextFd++;return this.fdMap[e]=t,e}fd2file(t){t=this.fdMap[t];if(t)return t;throw new u(h.EBADF,"Invalid file descriptor.")}closeFd(t){delete this.fdMap[t]}}});
//# sourceMappingURL=sourcemaps/file-system.js.map
