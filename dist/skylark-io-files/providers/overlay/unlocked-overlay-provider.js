/**
 * skylark-io-files - The skylark file system library
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["skylark-langx-paths","../base-provider","../../stats","../../file-type","../../file-error","../../error-codes","../../file-flag","../../action-type","./overlay-file"],function(c,e,a,t,o,d,i,h,l){const n="/.deletedFiles.log";function y(e){return 146|e}function _(e){return i.getFileFlag(e)}class r extends e{constructor(e,t){if(super(),this._isInitialized=!1,this._initializeCallbacks=[],this._deletedFiles={},this._deleteLog="",this._deleteLogUpdatePending=!1,this._deleteLogUpdateNeeded=!1,this._deleteLogError=null,this._writable=e,this._readable=t,this._writable.isReadOnly())throw new o(d.EINVAL,"Writable file system must be writable.")}static isAvailable(){return!0}getOverlayedProviders(){return{readable:this._readable,writable:this._writable}}_syncAsync(t,i){this.createParentDirectoriesAsync(t.getPath(),e=>{if(e)return i(e);this._writable.writeFile(t.getPath(),t.getBuffer(),null,_("w"),t.getStats().mode,i)})}_syncSync(e){this.createParentDirectories(e.getPath()),this._writable.writeFileSync(e.getPath(),e.getBuffer(),null,_("w"),e.getStats().mode)}getName(){return OverlayFS.Name}_initialize(e){const i=this._initializeCallbacks,r=t=>{this._isInitialized=!t,this._initializeCallbacks=[],i.forEach(e=>e(t))};if(this._isInitialized)return e();i.push(e),1===i.length&&this._writable.readFile(n,"utf8",_("r"),(e,t)=>{if(e){if(e.errno!==d.ENOENT)return r(e)}else this._deleteLog=t;this._reparseDeletionLog(),r()})}isReadOnly(){return!1}supportsSynch(){return this._readable.supportsSynch()&&this._writable.supportsSynch()}supportsLinks(){return!1}supportsProps(){return this._readable.supportsProps()&&this._writable.supportsProps()}getDeletionLog(){return this._deleteLog}restoreDeletionLog(e){this._deleteLog=e,this._reparseDeletionLog(),this.updateLog("")}rename(a,h,l){if(this.checkInitAsync(l)&&!this.checkPathAsync(a,l)&&!this.checkPathAsync(h,l))return a===n||h===n?l(o.EPERM("Cannot rename deletion log.")):a===h?l():void this.stat(a,!1,(e,n)=>e?l(e):this.stat(h,!1,(e,t)=>{const r=this;function s(t){var e=t.shift();if(!e)return l();var i=c.resolve(a,e),e=c.resolve(h,e);r.rename(i,e,e=>{if(e)return l(e);s(t)})}let i=511;if(n.isDirectory()){if(e)return e.errno!==d.ENOENT?l(e):this._writable.exists(a,e=>{if(e)return this._writable.rename(a,h,l);this._writable.mkdir(h,i,e=>{if(e)return l(e);this._readable.readdir(a,(e,t)=>{if(e)return l();s(t)})})});if(i=t.mode,!t.isDirectory())return l(o.ENOTDIR(h));this.readdir(h,(e,t)=>{if(t&&t.length)return l(o.ENOTEMPTY(h));this._readable.readdir(a,(e,t)=>{if(e)return l();s(t)})})}if(t&&t.isDirectory())return l(o.EISDIR(h));this.readFile(a,null,_("r"),(e,t)=>e?l(e):this.writeFile(h,t,null,_("w"),n.mode,e=>e?l(e):this.unlink(a,l)))}))}renameSync(t,i){if(this.checkInitialized(),this.checkPath(t),this.checkPath(i),t===n||i===n)throw o.EPERM("Cannot rename deletion log.");var e=this.statSync(t,!1);if(e.isDirectory()){if(t===i)return;let e=511;if(this.existsSync(i)){var r=this.statSync(i,!1);if(e=r.mode,!r.isDirectory())throw o.ENOTDIR(i);if(0<this.readdirSync(i).length)throw o.ENOTEMPTY(i)}this._writable.existsSync(t)?this._writable.renameSync(t,i):this._writable.existsSync(i)||this._writable.mkdirSync(i,e),this._readable.existsSync(t)&&this._readable.readdirSync(t).forEach(e=>{this.renameSync(c.resolve(t,e),c.resolve(i,e))})}else{if(this.existsSync(i)&&this.statSync(i,!1).isDirectory())throw o.EISDIR(i);this.writeFileSync(i,this.readFileSync(t,null,_("r")),null,_("w"),e.mode)}t!==i&&this.existsSync(t)&&this.unlinkSync(t)}stat(i,r,s){this.checkInitAsync(s)&&this._writable.stat(i,r,(e,t)=>{e&&e.errno===d.ENOENT?(this._deletedFiles[i]&&s(o.ENOENT(i)),this._readable.stat(i,r,(e,t)=>{t&&((t=a.clone(t)).mode=y(t.mode)),s(e,t)})):s(e,t)})}statSync(t,i){this.checkInitialized();try{return this._writable.statSync(t,i)}catch(e){if(this._deletedFiles[t])throw o.ENOENT(t);t=a.clone(this._readable.statSync(t,i));return t.mode=y(t.mode),t}}open(r,s,t,n){this.checkInitAsync(n)&&!this.checkPathAsync(r,n)&&this.stat(r,!1,(e,i)=>{if(!i)return s.pathNotExistsAction()!==h.CREATE_FILE?n(o.ENOENT(r)):this.createParentDirectoriesAsync(r,e=>e?n(e):this._writable.open(r,s,t,n));switch(s.pathExistsAction()){case h.TRUNCATE_FILE:return this.createParentDirectoriesAsync(r,e=>{if(e)return n(e);this._writable.open(r,s,t,n)});case h.NOP:return this._writable.exists(r,e=>{e?this._writable.open(r,s,t,n):((i=a.clone(i)).mode=t,this._readable.readFile(r,null,_("r"),(e,t)=>{if(e)return n(e);-1===i.size&&(i.size=t.length);e=new l(this,r,s,i,t);n(null,e)}))});default:return n(o.EEXIST(r))}})}openSync(e,t,i){if(this.checkInitialized(),this.checkPath(e),e===n)throw o.EPERM("Cannot open deletion log.");if(!this.existsSync(e)){if(t.pathNotExistsAction()!==h.CREATE_FILE)throw o.ENOENT(e);return this.createParentDirectories(e),this._writable.openSync(e,t,i)}switch(t.pathExistsAction()){case h.TRUNCATE_FILE:return this.createParentDirectories(e),this._writable.openSync(e,t,i);case h.NOP:var r,s;return this._writable.existsSync(e)?this._writable.openSync(e,t,i):(r=this._readable.readFileSync(e,null,_("r")),(s=a.clone(this._readable.statSync(e,!1))).mode=i,new l(this,e,t,s,r));default:throw o.EEXIST(e)}}unlink(t,i){this.checkInitAsync(i)&&!this.checkPathAsync(t,i)&&this.exists(t,e=>{if(!e)return i(o.ENOENT(t));this._writable.exists(t,e=>{if(e)return this._writable.unlink(t,e=>{if(e)return i(e);this.exists(t,e=>{e&&this.deletePath(t),i(null)})});this.deletePath(t),i(null)})})}unlinkSync(e){if(this.checkInitialized(),this.checkPath(e),!this.existsSync(e))throw o.ENOENT(e);this._writable.existsSync(e)&&this._writable.unlinkSync(e),this.existsSync(e)&&this.deletePath(e)}rmdir(i,r){if(this.checkInitAsync(r)){const t=()=>{this.readdir(i,(e,t)=>e?r(e):t.length?r(o.ENOTEMPTY(i)):(this.deletePath(i),void r(null)))};this.exists(i,e=>{if(!e)return r(o.ENOENT(i));this._writable.exists(i,e=>{e?this._writable.rmdir(i,e=>{if(e)return r(e);this._readable.exists(i,e=>{(e?t:r)()})}):t()})})}}rmdirSync(e){if(this.checkInitialized(),!this.existsSync(e))throw o.ENOENT(e);if(this._writable.existsSync(e)&&this._writable.rmdirSync(e),this.existsSync(e)){if(0<this.readdirSync(e).length)throw o.ENOTEMPTY(e);this.deletePath(e)}}mkdir(t,i,r){this.checkInitAsync(r)&&this.exists(t,e=>{if(e)return r(o.EEXIST(t));this.createParentDirectoriesAsync(t,e=>{if(e)return r(e);this._writable.mkdir(t,i,r)})})}mkdirSync(e,t){if(this.checkInitialized(),this.existsSync(e))throw o.EEXIST(e);this.createParentDirectories(e),this._writable.mkdirSync(e,t)}readdir(s,n){this.checkInitAsync(n)&&this.stat(s,!1,(e,t)=>e?n(e):t.isDirectory()?void this._writable.readdir(s,(e,r)=>{if(e&&"ENOENT"!==e.code)return n(e);!e&&r||(r=[]),this._readable.readdir(s,(e,t)=>{const i={};e=r.concat((t=!e&&t?t:[]).filter(e=>!this._deletedFiles[s+"/"+e])).filter(e=>{var t=!i[e];return i[e]=!0,t});n(null,e)})}):n(o.ENOTDIR(s)))}readdirSync(t){if(this.checkInitialized(),!this.statSync(t,!1).isDirectory())throw o.ENOTDIR(t);let e=[];try{e=e.concat(this._writable.readdirSync(t))}catch(e){}try{e=e.concat(this._readable.readdirSync(t).filter(e=>!this._deletedFiles[t+"/"+e]))}catch(e){}const i={};return e.filter(e=>{var t=!i[e];return i[e]=!0,t})}exists(t,i){this.checkInitialized(),this._writable.exists(t,e=>{if(e)return i(!0);this._readable.exists(t,e=>{i(e&&!0!==this._deletedFiles[t])})})}existsSync(e){return this.checkInitialized(),this._writable.existsSync(e)||this._readable.existsSync(e)&&!0!==this._deletedFiles[e]}chmod(t,i,r,s){this.checkInitAsync(s)&&this.operateOnWritableAsync(t,e=>{if(e)return s(e);this._writable.chmod(t,i,r,s)})}chmodSync(e,t,i){this.checkInitialized(),this.operateOnWritable(e,()=>{this._writable.chmodSync(e,t,i)})}chown(t,i,r,s,n){this.checkInitAsync(n)&&this.operateOnWritableAsync(t,e=>{if(e)return n(e);this._writable.chown(t,i,r,s,n)})}chownSync(e,t,i,r){this.checkInitialized(),this.operateOnWritable(e,()=>{this._writable.chownSync(e,t,i,r)})}utimes(t,i,r,s){this.checkInitAsync(s)&&this.operateOnWritableAsync(t,e=>{if(e)return s(e);this._writable.utimes(t,i,r,s)})}utimesSync(e,t,i){this.checkInitialized(),this.operateOnWritable(e,()=>{this._writable.utimesSync(e,t,i)})}deletePath(e){this._deletedFiles[e]=!0,this.updateLog(`d${e}
`)}updateLog(e){this._deleteLog+=e,this._deleteLogUpdatePending?this._deleteLogUpdateNeeded=!0:(this._deleteLogUpdatePending=!0,this._writable.writeFile(n,this._deleteLog,"utf8",i.getFileFlag("w"),420,e=>{this._deleteLogUpdatePending=!1,e?this._deleteLogError=e:this._deleteLogUpdateNeeded&&(this._deleteLogUpdateNeeded=!1,this.updateLog(""))}))}_reparseDeletionLog(){this._deletedFiles={},this._deleteLog.split("\n").forEach(e=>{this._deletedFiles[e.slice(1)]="d"===e.slice(0,1)})}checkInitialized(){if(!this._isInitialized)throw new o(d.EPERM,"OverlayProvideris not initialized. Please initialize OverlayProviderusing its initialize() method before using it.");var e;if(null!==this._deleteLogError)throw e=this._deleteLogError,this._deleteLogError=null,e}checkInitAsync(e){var t;return this._isInitialized?null===this._deleteLogError||(t=this._deleteLogError,this._deleteLogError=null,e(t),!1):(e(new o(d.EPERM,"OverlayProvideris not initialized. Please initialize OverlayProviderusing its initialize() method before using it.")),!1)}checkPath(e){if(e===n)throw o.EPERM(e)}checkPathAsync(e,t){return e===n&&(t(o.EPERM(e)),!0)}createParentDirectoriesAsync(e,r){let s=c.dirname(e);const n=[],a=this;function h(){if(!n.length)return r();const i=n.pop();a._readable.stat(i,!1,(e,t)=>{if(!t)return r();a._writable.mkdir(i,t.mode,e=>{if(e)return r(e);h()})})}this._writable.stat(s,!1,function e(t,i){t?"/"===s?r(new o(d.EBUSY,"Invariant failed: root does not exist!")):(n.push(s),s=c.dirname(s),a._writable.stat(s,!1,e)):h()})}createParentDirectories(e){let t=c.dirname(e),i=[];for(;!this._writable.existsSync(t);)i.push(t),t=c.dirname(t);(i=i.reverse()).forEach(e=>{this._writable.mkdirSync(e,this.statSync(e,!1).mode)})}operateOnWritable(e,t){if(!this.existsSync(e))throw o.ENOENT(e);this._writable.existsSync(e)||this.copyToWritable(e),t()}operateOnWritableAsync(t,i){this.exists(t,e=>{if(!e)return i(o.ENOENT(t));this._writable.exists(t,e=>{if(!e)return this.copyToWritableAsync(t,i);i()})})}copyToWritable(e){var t=this.statSync(e,!1);t.isDirectory()?this._writable.mkdirSync(e,t.mode):this.writeFileSync(e,this._readable.readFileSync(e,null,_("r")),null,_("w"),this.statSync(e,!1).mode)}copyToWritableAsync(r,s){this.stat(r,!1,(e,i)=>e?s(e):i.isDirectory()?this._writable.mkdir(r,i.mode,s):void this._readable.readFile(r,null,_("r"),(e,t)=>{if(e)return s(e);this.writeFile(r,t,null,_("w"),i.mode,s)}))}}return r});
//# sourceMappingURL=../../sourcemaps/providers/overlay/unlocked-overlay-provider.js.map
