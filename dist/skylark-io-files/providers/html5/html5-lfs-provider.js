/**
 * skylark-io-files - The skylark file system library
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["skylark-langx-async","skylark-langx-paths","../../files","../registry","../../preload-file","../base-provider","../../error-codes","../../file-error","../../action-type","../../stats","../../file-type","../../utils","./html5-lfs-file"],function(e,c,r,t,i,s,u,d,l,a,n,o,E){"use strict";const f=e.each,h=o["arrayBuffer2Buffer"];const y=window.webkitRequestProvider||window.requestProvider||null;function p(e,r,t){switch(e.name){case"PathExistsError":return d.EEXIST(r);case"QuotaExceededError":return d.FileError(u.ENOSPC,r);case"NotFoundError":return d.ENOENT(r);case"SecurityError":return d.FileError(u.EACCES,r);case"InvalidModificationError":return d.FileError(u.EPERM,r);case"TypeMismatchError":return d.FileError(t?u.ENOTDIR:u.EISDIR,r);default:return d.FileError(u.EINVAL,r)}}class w extends s{constructor(e=5,r=window.PERSISTENT){super(),this.size=1048576*e,this.type=r}static Create(e,r){const t=new w(e.size,e.type);t._allocate(e=>e?r(e):r(null,t))}static isAvailable(){return!!y}getName(){return w.Name}isReadOnly(){return!1}supportsSymlinks(){return!1}supportsProps(){return!1}supportsSynch(){return!1}empty(t){this._readdir("/",(r,e)=>{r?t(r):f(e,(r,t)=>{var e=()=>{t()},i=e=>{t(p(e,r.fullPath,!r.isDirectory))};r.isDirectory?r.removeRecursively(e,i):r.remove(e,i)},e=>{r?t(r):t()})})}rename(i,s,o){let r=2,e=0;const a=this.fs.root;let n=i;const l=e=>{--r<=0&&o(p(e,n,!1))};var t=t=>2==++e?o(new d(u.EINVAL,"Something was identified as both a file and a directory. This should never happen.")):i===s?o():(n=c.dirname(s),void a.getDirectory(n,{},e=>{n=c.basename(s),t.moveTo(e,n,e=>{o()},r=>{t.isDirectory?(n=s,this.unlink(s,e=>{e?l(r):this.rename(i,s,o)})):l(r)})},l));a.getFile(i,{},t,l),a.getDirectory(i,{},t,l)}stat(r,e,t){const i={create:!1};const s=e=>{var r=new a(n.DIRECTORY,4096);t(null,r)},o=e=>{t(p(e,r,!1))};this.fs.root.getFile(r,i,e=>{e.file(e=>{e=new a(n.FILE,e.size);t(null,e)},o)},()=>{this.fs.root.getDirectory(r,i,s,o)})}open(o,a,e,n){const r=e=>{"InvalidModificationError"===e.name&&a.isExclusive()?n(d.EEXIST(o)):n(p(e,o,!1))};this.fs.root.getFile(o,{create:a.pathNotExistsAction()===l.CREATE_FILE,exclusive:a.isExclusive()},s=>{s.file(t=>{const i=new FileReader;i.onloadend=e=>{var r=this._makeFile(o,s,a,t,i.result);n(null,r)},i.onerror=e=>{r(i.error)},i.readAsArrayBuffer(t)},r)},r)}unlink(e,r){this._remove(e,r,!0)}rmdir(t,i){this.readdir(t,(e,r)=>{e?i(e):0<r.length?i(d.ENOTEMPTY(t)):this._remove(t,i,!1)})}mkdir(r,e,t){this.fs.root.getDirectory(r,{create:!0,exclusive:!0},e=>{t()},e=>{t(p(e,r,!0))})}readdir(e,s){this._readdir(e,(e,r)=>{if(!r)return s(e);var t=[];for(const i of r)t.push(i.name);s(null,t)})}_makeFile(e,r,t,i,s=new ArrayBuffer(0)){i=new a(n.FILE,i.size),s=h(s);return new E(this,r,e,t,i,s)}_readdir(r,s){const o=e=>{s(p(e,r,!0))};this.fs.root.getDirectory(r,{create:!1},e=>{const r=e.createReader();let t=[];const i=()=>{r.readEntries(e=>{e.length?(t=t.concat(Array.prototype.slice.call(e||[],0)),i()):s(null,t)},o)};i()},o)}_allocate(r){const t=e=>{this.fs=e,r()},i=e=>{r(p(e,"/",!0))};if(this.type===window.PERSISTENT){var e=this.type,s=this.size,o=e=>{y(this.type,e,t,i)},a=i;if(void 0!==navigator.webkitPersistentStorage)switch(e){case window.PERSISTENT:navigator.webkitPersistentStorage.requestQuota(s,o,a);break;case window.TEMPORARY:navigator.webkitTemporaryStorage.requestQuota(s,o,a);break;default:a(new TypeError("Invalid storage type: "+e))}else window.webkitStorageInfo.requestQuota(e,s,o,a)}else y(this.type,this.size,t,i)}_remove(r,t,i){var e=e=>{e.remove(()=>{t()},e=>{t(p(e,r,!i))})},s=e=>{t(p(e,r,!i))},o={create:!1};i?this.fs.root.getFile(r,o,e,s):this.fs.root.getDirectory(r,o,e,s)}}return w.Name="Html5LfsProvider",w.Options={size:{type:"number",optional:!0,description:"Storage quota to request, in megabytes. Allocated value may be less. Defaults to 5."},type:{type:"number",optional:!0,description:"window.PERSISTENT or window.TEMPORARY. Defaults to PERSISTENT."}},w.Html5LfsFile=E,t.add("html5Lfs",w),w});
//# sourceMappingURL=../../sourcemaps/providers/html5/html5-lfs-provider.js.map
