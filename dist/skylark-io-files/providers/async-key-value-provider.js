/**
 * skylark-io-files - The skylark file system library
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["skylark-langx-strings/generate-uuid","skylark-langx-binary/buffer","skylark-langx-paths","skylark-data-collections/lru-cache","../files","../error-codes","../file-error","../file-type","../utils","../inodes/inode","./base-provider","./async-key-value-file"],function(o,y,E,t,e,b,I,a,i,m,r,c){"use strict";const d=i["emptyBuffer"],l="/";let h=null;function f(e,t){if(!e)return 1;t(e)}function p(e,t,i){if(!e)return 1;t.abort(()=>{i(e)})}class n extends r{constructor(e){super(),this._cache=null,0<e&&(this._cache=new t(e))}static isAvailable(){return!0}init(e,t){this.store=e,this.makeRootDirectory(t)}getName(){return this.store.name()}isReadOnly(){return!1}supportsSymlinks(){return!1}supportsProps(){return!1}supportsSynch(){return!1}empty(t){this._cache&&this._cache.removeAll(),this.store.clear(e=>{f(e,t)&&this.makeRootDirectory(t)})}rename(o,a,c){if(this._cache){const t=this._cache,i=(this._cache=null,t.removeAll(),c);c=e=>{this._cache=t,i(e)}}const d=this.store.beginTransaction("readwrite"),l=E.dirname(o),h=E.basename(o),m=E.dirname(a),f=E.basename(a),u={},N={};let g=!1;if(0===(m+"/").indexOf(o+"/"))return c(new I(b.EBUSY,l));const n=()=>{if(!g&&N.hasOwnProperty(l)&&N.hasOwnProperty(m)){const e=N[l],t=u[l],i=N[m],r=u[m];if(e[h]){const n=e[h],s=(delete e[h],()=>{i[f]=n,d.put(t.id,y.from(JSON.stringify(e)),!0,e=>{p(e,d,c)&&(l===m?d.commit(c):d.put(r.id,y.from(JSON.stringify(i)),!0,e=>{p(e,d,c)&&d.commit(c)}))})});i[f]?this.getINode(d,a,i[f],(e,t)=>{p(e,d,c)&&(t.isFile()?d.del(t.id,e=>{p(e,d,c)&&d.del(i[f],e=>{p(e,d,c)&&s()})}):d.abort(e=>{c(I.EPERM(a))}))}):s()}else c(I.ENOENT(o))}};var e=r=>{this.findINodeAndDirListing(d,r,(e,t,i)=>{e?g||(g=!0,d.abort(()=>{c(e)})):(u[r]=t,N[r]=i,n())})};e(l),l!==m&&e(m)}stat(e,t,i){var r=this.store.beginTransaction("readonly");this.findINode(r,e,(e,t)=>{f(e,i)&&i(null,t.toStats())})}createFile(i,r,e,n){const t=this.store.beginTransaction("readwrite"),s=d();this.commitNewFile(t,i,a.FILE,e,s,(e,t)=>{f(e,n)&&n(null,new c(this,i,r,t.toStats(),s))})}openFile(r,n,s){const t=this.store.beginTransaction("readonly");this.findINode(t,r,(e,i)=>{f(e,s)&&t.get(i.id,(e,t)=>{f(e,s)&&(void 0===t?s(I.ENOENT(r)):s(null,new c(this,r,n,i.toStats(),t)))})})}unlink(e,t){this.removeEntry(e,!1,t)}rmdir(i,r){this.readdir(i,(e,t)=>{e?r(e):0<t.length?r(I.ENOTEMPTY(i)):this.removeEntry(i,!0,r)})}mkdir(e,t,i){var r=this.store.beginTransaction("readwrite"),n=y.from("{}");this.commitNewFile(r,e,a.DIRECTORY,t,n,i)}readdir(i,r){const n=this.store.beginTransaction("readonly");this.findINode(n,i,(e,t)=>{f(e,r)&&this.getDirListing(n,i,t,(e,t)=>{f(e,r)&&r(null,Object.keys(t))})})}_sync(t,n,s,o){const a=this.store.beginTransaction("readwrite");this._findINode(a,E.dirname(t),E.basename(t),(e,r)=>{p(e,a,o)&&this.getINode(a,t,r,(e,t)=>{if(p(e,a,o)){const i=t.update(s);a.put(t.id,n,!0,e=>{p(e,a,o)&&(i?a.put(r,t.toBuffer(),!0,e=>{p(e,a,o)&&a.commit(o)}):a.commit(o))})}})})}makeRootDirectory(n){const s=this.store.beginTransaction("readwrite");s.get(l,(e,t)=>{if(e||void 0===t){const i=(new Date).getTime(),r=new m(o(),4096,511|a.DIRECTORY,i,i,i);s.put(r.id,h=h||y.from("{}"),!1,e=>{p(e,s,n)&&s.put(l,r.toBuffer(),!1,e=>{e?s.abort(()=>{n(e)}):s.commit(n)})})}else s.commit(n)})}_findINode(i,r,n,s){if(this._cache){var e=this._cache.get(E.join(r,n));if(e)return s(null,e)}const o=(e,t,i)=>{e?s(e):i[n]?(e=i[n],this._cache&&this._cache.set(E.join(r,n),e),s(null,e)):s(I.ENOENT(E.resolve(r,n)))};"/"===r?""===n?(this._cache&&this._cache.set(E.join(r,n),l),s(null,l)):this.getINode(i,r,l,(e,t)=>{f(e,s)&&this.getDirListing(i,r,t,(e,t)=>{o(e,0,t)})}):this.findINodeAndDirListing(i,r,o)}findINode(i,r,n){this._findINode(i,E.dirname(r),E.basename(r),(e,t)=>{f(e,n)&&this.getINode(i,r,t,n)})}getINode(e,i,t,r){e.get(t,(e,t)=>{f(e,r)&&(void 0===t?r(I.ENOENT(i)):r(null,m.fromBuffer(t)))})}getDirListing(e,i,t,r){t.isDirectory()?e.get(t.id,(e,t)=>{if(f(e,r))try{r(null,JSON.parse(t.toString()))}catch(e){r(I.ENOENT(i))}}):r(I.ENOTDIR(i))}findINodeAndDirListing(t,r,n){this.findINode(t,r,(e,i)=>{f(e,n)&&this.getDirListing(t,r,i,(e,t)=>{f(e,n)&&n(null,i,t)})})}addNewNode(e,t,i){let r=0,n;const s=()=>{5==++r?i(new I(b.EIO,"Unable to commit data to key-value store.")):(n=o(),e.put(n,t,!1,(e,t)=>{e||!t?s():i(null,n)}))};s()}commitNewFile(s,t,o,a,c,d){const e=E.dirname(t),l=E.basename(t),h=(new Date).getTime();if("/"===t)return d(I.EEXIST(t));this.findINodeAndDirListing(s,e,(e,r,n)=>{p(e,s,d)&&(n[l]?s.abort(()=>{d(I.EEXIST(t))}):this.addNewNode(s,c,(e,t)=>{if(p(e,s,d)){const i=new m(t,c.length,a|o,h,h,h);this.addNewNode(s,i.toBuffer(),(e,t)=>{p(e,s,d)&&(n[l]=t,s.put(r.id,y.from(JSON.stringify(n)),!0,e=>{p(e,s,d)&&s.commit(e=>{p(e,s,d)&&d(null,i)})}))})}}))})}removeEntry(s,o,a){this._cache&&this._cache.remove(s);const c=this.store.beginTransaction("readwrite"),e=E.dirname(s),t=E.basename(s);this.findINodeAndDirListing(c,e,(e,i,r)=>{if(p(e,c,a))if(r[t]){const n=r[t];delete r[t],this.getINode(c,s,n,(e,t)=>{p(e,c,a)&&(!o&&t.isDirectory()?c.abort(()=>{a(I.EISDIR(s))}):o&&!t.isDirectory()?c.abort(()=>{a(I.ENOTDIR(s))}):c.del(t.id,e=>{p(e,c,a)&&c.del(n,e=>{p(e,c,a)&&c.put(i.id,y.from(JSON.stringify(r)),!0,e=>{p(e,c,a)&&c.commit(a)})})}))})}else c.abort(()=>{a(I.ENOENT(s))})})}}return e.providers.AsyncKeyValueProvider=n});
//# sourceMappingURL=../sourcemaps/providers/async-key-value-provider.js.map
