/**
 * skylark-io-files - The skylark file system library
 * @author Hudaokeji Co.,Ltd
 * @version v0.9.0
 * @link www.skylarkjs.org
 * @license MIT
 */
define(["skylark-langx-binary/buffer","skylark-langx-paths","../base-provider","../../stats","../../file-type","../../file-error","../../error-codes","../../file-flag","../../action-type","../../base-file","../../utils","../preload-file","./callback-argument-converter","./worker-file"],function(u,e,r,f,t,g,s,h,o,m,a,i,n,c){const l=a["emptyBuffer"];class p extends r{constructor(e){super(),this._callbackConverter=new n,this._isInitialized=!1,this._isReadOnly=!1,this._supportLinks=!1,this._supportProps=!1,this._worker=e,this._worker.addEventListener("message",r=>{r=r.data;if(isAPIResponse(r)){let e;var t=r.args,s=new Array(t.length);for(e=0;e<s.length;e++)s[e]=this._argRemote2Local(t[e]);this._callbackConverter.toLocalArg(r.cbId).apply(null,s)}})}static Create(e,r){const t=new p(e.worker);t._initialize(()=>{r(null,t)})}static isAvailable(){return"undefined"!=typeof importScripts||"undefined"!=typeof Worker}static attachRemoteListener(l){const p=new FileDescriptorArgumentConverter;function n(e,n){if(e&&"object"==typeof e){if("number"!=typeof e.type)return e;var r=e;switch(r.type){case SpecialArgType.CB:const c=e.id;return function(){let e;const o=new Array(arguments.length);let a,i=arguments.length;for(e=0;e<arguments.length;e++)((t,e)=>{var r,s;r=n,s=(e,r)=>{o[t]=r,e?(r=e,0<i&&(i=-1,a={browserfsMessage:!0,cbId:c,args:[FileErrorLocal2Remote(r)]},l.postMessage(a))):0==--i&&(a={browserfsMessage:!0,cbId:c,args:o},l.postMessage(a))},"object"==typeof(e=e)?e instanceof f?s(null,statsLocal2Remote(e)):e instanceof g?s(null,FileErrorLocal2Remote(e)):e instanceof m?s(null,p.toRemoteArg(e,r[0],r[1],s)):e instanceof h?s(null,fileFlagLocal2Remote(e)):e instanceof u?s(null,bufferLocal2Remote(e)):e instanceof Error?s(null,errorLocal2Remote(e)):s(null,e):s(null,e)})(e,arguments[e]);0===arguments.length&&(a={browserfsMessage:!0,cbId:c,args:o},l.postMessage(a))};case SpecialArgType.API_ERROR:return FileErrorRemote2Local(r);case SpecialArgType.STATS:return statsRemote2Local(r);case SpecialArgType.FILEFLAG:return fileFlagRemote2Local(r);case SpecialArgType.BUFFER:return bufferRemote2Local(r);case SpecialArgType.ERROR:return errorRemote2Local(r);default:return e}}return e}l.addEventListener("message",e=>{const r=e.data;if(isAPIRequest(r)){const o=r.args,a=new Array(o.length);switch(r.method){case"close":case"sync":{const i=o[1];p.applyFdAPIRequest(r,e=>{e={browserfsMessage:!0,cbId:i.id,args:e?[FileErrorLocal2Remote(e)]:[]};l.postMessage(e)})}break;case"probe":t=fs.getRootFS(),s=o[1],t={type:SpecialArgType.PROBE,isReadOnly:t.isReadOnly(),supportsLinks:t.supportsLinks(),supportsProps:t.supportsProps()},s={browserfsMessage:!0,cbId:s.id,args:[t]},l.postMessage(s);break;default:for(let e=0;e<o.length;e++)a[e]=n(o[e],a);t=fs.getRootFS();t[r.method].apply(t,a)}}var t,s})}getName(){return p.Name}isReadOnly(){return this._isReadOnly}supportsSynch(){return!1}supportsLinks(){return this._supportLinks}supportsProps(){return this._supportProps}rename(e,r,t){this._rpc("rename",arguments)}stat(e,r,t){this._rpc("stat",arguments)}open(e,r,t,s){this._rpc("open",arguments)}unlink(e,r){this._rpc("unlink",arguments)}rmdir(e,r){this._rpc("rmdir",arguments)}mkdir(e,r,t){this._rpc("mkdir",arguments)}readdir(e,r){this._rpc("readdir",arguments)}exists(e,r){this._rpc("exists",arguments)}realpath(e,r,t){this._rpc("realpath",arguments)}truncate(e,r,t){this._rpc("truncate",arguments)}readFile(e,r,t,s){this._rpc("readFile",arguments)}writeFile(e,r,t,s,o,a){this._rpc("writeFile",arguments)}appendFile(e,r,t,s,o,a){this._rpc("appendFile",arguments)}chmod(e,r,t,s){this._rpc("chmod",arguments)}chown(e,r,t,s,o){this._rpc("chown",arguments)}utimes(e,r,t,s){this._rpc("utimes",arguments)}link(e,r,t){this._rpc("link",arguments)}symlink(e,r,t,s){this._rpc("symlink",arguments)}readlink(e,r){this._rpc("readlink",arguments)}syncClose(e,r,t){this._worker.postMessage({browserfsMessage:!0,method:e,args:[r.toRemoteArg(),this._callbackConverter.toRemoteArg(t)]})}_initialize(r){var e;this._isInitialized?r():(e={browserfsMessage:!0,method:"probe",args:[this._argLocal2Remote(l()),this._callbackConverter.toRemoteArg(e=>{this._isInitialized=!0,this._isReadOnly=e.isReadOnly,this._supportLinks=e.supportsLinks,this._supportProps=e.supportsProps,r()})]},this._worker.postMessage(e))}_argRemote2Local(e){if(e&&"object"==typeof e){if("number"!=typeof e.type)return e;var r=e;switch(r.type){case SpecialArgType.API_ERROR:return misc.FileErrorRemote2Local(r);case SpecialArgType.FD:var t=r;return new c(this,t.path,h.getFileFlag(t.flag),f.fromBuffer(transferrableObjectToBuffer(t.stat)),t.id,transferrableObjectToBuffer(t.data));case SpecialArgType.STATS:return misc.statsRemote2Local(r);case SpecialArgType.FILEFLAG:return misc.fileFlagRemote2Local(r);case SpecialArgType.BUFFER:return misc.bufferRemote2Local(r);case SpecialArgType.ERROR:return misc.errorRemote2Local(r);default:return e}}return e}_rpc(e,r){var t=new Array(r.length);for(let e=0;e<r.length;e++)t[e]=this._argLocal2Remote(r[e]);this._worker.postMessage({browserfsMessage:!0,method:e,args:t})}_argLocal2Remote(e){if(!e)return e;switch(typeof e){case"object":return e instanceof f?statsLocal2Remote(e):e instanceof g?FileErrorLocal2Remote(e):e instanceof c?e.toRemoteArg():e instanceof h?fileFlagLocal2Remote(e):e instanceof u?bufferLocal2Remote(e):e instanceof Error?errorLocal2Remote(e):"Unknown argument";case"function":return this._callbackConverter.toRemoteArg(e);default:return e}}}return p.Name="WorkerProvider",p.Options={worker:{type:"object",description:"The target worker that you want to connect to, or the current worker if in a worker context.",validator:function(e,r){e.postMessage?r():r(new g(s.EINVAL,"option must be a Web Worker instance."))}}},p});
//# sourceMappingURL=../../sourcemaps/providers/worker/worker-provider.js.map
