{"version":3,"sources":["providers/simple-sync-rw-transaction.js"],"names":["define","files","ErrorCodes","FileError","providers","SimpleSyncRWTransaction","constructor","store","this","originalData","modifiedKeys","get","key","val","stashOldValue","put","data","overwrite","markModified","del","commit","abort","value","hasOwnProperty","indexOf","push"],"mappings":";;;;;;;AAAAA,OAAO,CACH,WACA,iBACA,iBACD,SAAUC,EAAOC,EAAYC,GAC5B,aAyEA,OAAOF,EAAMG,UAAUC,8BAlEnBC,YAAYC,GACRC,KAAKD,MAAQA,EAKbC,KAAKC,aAAe,GAIpBD,KAAKE,aAAe,EACxB,CACAC,IAAIC,GACA,IAAMC,EAAML,KAAKD,MAAMI,IAAIC,CAAG,EAE9B,OADAJ,KAAKM,cAAcF,EAAKC,CAAG,EACpBA,CACX,CACAE,IAAIH,EAAKI,EAAMC,GAEX,OADAT,KAAKU,aAAaN,CAAG,EACdJ,KAAKD,MAAMQ,IAAIH,EAAKI,EAAMC,CAAS,CAC9C,CACAE,IAAIP,GACAJ,KAAKU,aAAaN,CAAG,EACrBJ,KAAKD,MAAMY,IAAIP,CAAG,CACtB,CACAQ,UACAC,QAEI,IAAK,MAAMT,KAAOJ,KAAKE,aAAc,CACjC,IAAMY,EAAQd,KAAKC,aAAaG,GAC3BU,EAMDd,KAAKD,MAAMQ,IAAIH,EAAKU,EAAO,CAAA,CAAI,EAJ/Bd,KAAKD,MAAMY,IAAIP,CAAG,CAM1B,CACJ,CAOAE,cAAcF,EAAKU,GAEVd,KAAKC,aAAac,eAAeX,CAAG,IACrCJ,KAAKC,aAAaG,GAAOU,EAEjC,CAKAJ,aAAaN,GAC8B,CAAC,IAApCJ,KAAKE,aAAac,QAAQZ,CAAG,IAC7BJ,KAAKE,aAAae,KAAKb,CAAG,EACrBJ,KAAKC,aAAac,eAAeX,CAAG,IACrCJ,KAAKC,aAAaG,GAAOJ,KAAKD,MAAMI,IAAIC,CAAG,GAGvD,CACJ,CAGJ,CAAC","file":"../../providers/simple-sync-rw-transaction.js","sourcesContent":["define([\r\n    \"../files\",\r\n    \"../error-codes\",\r\n    '../file-error'\r\n], function (files, ErrorCodes, FileError) {\r\n    'use strict';\r\n\r\n\r\n    /**\r\n     * A simple RW transaction for simple synchronous key-value stores.\r\n     */\r\n    class SimpleSyncRWTransaction {\r\n        constructor(store) {\r\n            this.store = store;\r\n            /**\r\n             * Stores data in the keys we modify prior to modifying them.\r\n             * Allows us to roll back commits.\r\n             */\r\n            this.originalData = {};\r\n            /**\r\n             * List of keys modified in this transaction, if any.\r\n             */\r\n            this.modifiedKeys = [];\r\n        }\r\n        get(key) {\r\n            const val = this.store.get(key);\r\n            this.stashOldValue(key, val);\r\n            return val;\r\n        }\r\n        put(key, data, overwrite) {\r\n            this.markModified(key);\r\n            return this.store.put(key, data, overwrite);\r\n        }\r\n        del(key) {\r\n            this.markModified(key);\r\n            this.store.del(key);\r\n        }\r\n        commit() { }\r\n        abort() {\r\n            // Rollback old values.\r\n            for (const key of this.modifiedKeys) {\r\n                const value = this.originalData[key];\r\n                if (!value) {\r\n                    // Key didn't exist.\r\n                    this.store.del(key);\r\n                }\r\n                else {\r\n                    // Key existed. Store old value.\r\n                    this.store.put(key, value, true);\r\n                }\r\n            }\r\n        }\r\n        /**\r\n         * Stashes given key value pair into `originalData` if it doesn't already\r\n         * exist. Allows us to stash values the program is requesting anyway to\r\n         * prevent needless `get` requests if the program modifies the data later\r\n         * on during the transaction.\r\n         */\r\n        stashOldValue(key, value) {\r\n            // Keep only the earliest value in the transaction.\r\n            if (!this.originalData.hasOwnProperty(key)) {\r\n                this.originalData[key] = value;\r\n            }\r\n        }\r\n        /**\r\n         * Marks the given key as modified, and stashes its value if it has not been\r\n         * stashed already.\r\n         */\r\n        markModified(key) {\r\n            if (this.modifiedKeys.indexOf(key) === -1) {\r\n                this.modifiedKeys.push(key);\r\n                if (!this.originalData.hasOwnProperty(key)) {\r\n                    this.originalData[key] = this.store.get(key);\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    return files.providers.SimpleSyncRWTransaction = SimpleSyncRWTransaction;\r\n});"]}