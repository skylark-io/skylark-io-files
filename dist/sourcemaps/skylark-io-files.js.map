{"version":3,"sources":["skylark-io-files.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AACA;AACA;AACA","file":"../skylark-io-files.js","sourcesContent":["define(\"skylark-io-files/files\",[\"skylark-langx-ns\"],function(e){return e.attach(\"data.files\",{providers:{}})}),define(\"skylark-io-files/action-type\",[\"./files\"],function(e){\"use strict\";var t,r;return(r=t=t||{})[r.NOP=0]=\"NOP\",r[r.THROW_EXCEPTION=1]=\"THROW_EXCEPTION\",r[r.TRUNCATE_FILE=2]=\"TRUNCATE_FILE\",r[r.CREATE_FILE=3]=\"CREATE_FILE\",e.ActionType=t}),define(\"skylark-io-files/error-codes\",[\"./files\"],function(e){\"use strict\";var t,r;return(r=t=t||{})[r.EPERM=1]=\"EPERM\",r[r.ENOENT=2]=\"ENOENT\",r[r.EIO=5]=\"EIO\",r[r.EBADF=9]=\"EBADF\",r[r.EACCES=13]=\"EACCES\",r[r.EBUSY=16]=\"EBUSY\",r[r.EEXIST=17]=\"EEXIST\",r[r.ENOTDIR=20]=\"ENOTDIR\",r[r.EISDIR=21]=\"EISDIR\",r[r.EINVAL=22]=\"EINVAL\",r[r.EFBIG=27]=\"EFBIG\",r[r.ENOSPC=28]=\"ENOSPC\",r[r.EROFS=30]=\"EROFS\",r[r.ENOTEMPTY=39]=\"ENOTEMPTY\",r[r.ENOTSUP=95]=\"ENOTSUP\",e.ErrorCodes=t}),define(\"skylark-io-files/error-strings\",[\"./files\",\"./error-codes\"],function(e,t){\"use strict\";var r={};return r[t.EPERM]=\"Operation not permitted.\",r[t.ENOENT]=\"No such file or directory.\",r[t.EIO]=\"Input/output error.\",r[t.EBADF]=\"Bad file descriptor.\",r[t.EACCES]=\"Permission denied.\",r[t.EBUSY]=\"Resource busy or locked.\",r[t.EEXIST]=\"File exists.\",r[t.ENOTDIR]=\"File is not a directory.\",r[t.EISDIR]=\"File is a directory.\",r[t.EINVAL]=\"Invalid argument.\",r[t.EFBIG]=\"File is too big.\",r[t.ENOSPC]=\"No space left on disk.\",r[t.EROFS]=\"Cannot modify a read-only file system.\",r[t.ENOTEMPTY]=\"Directory is not empty.\",r[t.ENOTSUP]=\"Operation is not supported.\",e.ErrorStrings=r}),define(\"skylark-io-files/file-error\",[\"skylark-langx-binary/buffer\",\"./files\",\"./error-codes\",\"./error-strings\"],function(i,e,s,n){\"use strict\";class r extends Error{constructor(e,t=n[e],r){super(t),this.syscall=\"\",this.errno=e,this.code=s[e],this.path=r,this.stack=(new Error).stack,this.message=`Error: ${this.code}: `+t+(this.path?`, '${this.path}'`:\"\")}static fromJSON(e){var t=new r(0);return t.errno=e.errno,t.code=e.code,t.path=e.path,t.stack=e.stack,t.message=e.message,t}static fromBuffer(e,t=0){return r.fromJSON(JSON.parse(e.toString(\"utf8\",t+4,t+4+e.readUInt32LE(t))))}static create(e,t){return new r(e,n[e],t)}static ENOENT(e){return this.create(s.ENOENT,e)}static EEXIST(e){return this.create(s.EEXIST,e)}static EISDIR(e){return this.create(s.EISDIR,e)}static ENOTDIR(e){return this.create(s.ENOTDIR,e)}static EPERM(e){return this.create(s.EPERM,e)}static ENOTEMPTY(e){return this.create(s.ENOTEMPTY,e)}toString(){return this.message}toJSON(){return{errno:this.errno,code:this.code,path:this.path,stack:this.stack,message:this.message}}writeToBuffer(e=i.alloc(this.bufferSize()),t=0){var r=e.write(JSON.stringify(this.toJSON()),t+4);return e.writeUInt32LE(r,t),e}bufferSize(){return 4+i.byteLength(JSON.stringify(this.toJSON()))}}return e.FileError=r}),define(\"skylark-io-files/base-file\",[\"./files\",\"./error-codes\",\"./file-error\"],function(e,i,s){\"use strict\";return e.BaseFile=class{sync(e){e(new s(i.ENOTSUP))}syncSync(){throw new s(i.ENOTSUP)}datasync(e){this.sync(e)}datasyncSync(){return this.syncSync()}chown(e,t,r){r(new s(i.ENOTSUP))}chownSync(e,t){throw new s(i.ENOTSUP)}chmod(e,t){t(new s(i.ENOTSUP))}chmodSync(e){throw new s(i.ENOTSUP)}utimes(e,t,r){r(new s(i.ENOTSUP))}utimesSync(e,t){throw new s(i.ENOTSUP)}}}),define(\"skylark-io-files/file-flag\",[\"./files\",\"./error-codes\",\"./file-error\",\"./action-type\"],function(e,t,r,i){\"use strict\";class s{constructor(e){if(this.flagStr=e,s.validFlagStrs.indexOf(e)<0)throw new r(t.EINVAL,\"Invalid flag: \"+e)}static getFileFlag(e){return s.flagCache.hasOwnProperty(e)?s.flagCache[e]:s.flagCache[e]=new s(e)}getFlagString(){return this.flagStr}isReadable(){return-1!==this.flagStr.indexOf(\"r\")||-1!==this.flagStr.indexOf(\"+\")}isWriteable(){return-1!==this.flagStr.indexOf(\"w\")||-1!==this.flagStr.indexOf(\"a\")||-1!==this.flagStr.indexOf(\"+\")}isTruncating(){return-1!==this.flagStr.indexOf(\"w\")}isAppendable(){return-1!==this.flagStr.indexOf(\"a\")}isSynchronous(){return-1!==this.flagStr.indexOf(\"s\")}isExclusive(){return-1!==this.flagStr.indexOf(\"x\")}pathExistsAction(){return this.isExclusive()?i.THROW_EXCEPTION:this.isTruncating()?i.TRUNCATE_FILE:i.NOP}pathNotExistsAction(){return(this.isWriteable()||this.isAppendable())&&\"r+\"!==this.flagStr?i.CREATE_FILE:i.THROW_EXCEPTION}}return s.flagCache={},s.validFlagStrs=[\"r\",\"r+\",\"rs\",\"rs+\",\"w\",\"wx\",\"w+\",\"wx+\",\"a\",\"ax\",\"a+\",\"ax+\"],e.FileFlag=s}),define(\"skylark-io-files/file-type\",[\"./files\"],function(e){\"use strict\";var t,r;return(r=t=t||{})[r.FILE=32768]=\"FILE\",r[r.DIRECTORY=16384]=\"DIRECTORY\",r[r.SYMLINK=40960]=\"SYMLINK\",e.FileType=t}),define(\"skylark-io-files/stats\",[\"skylark-langx-binary/buffer\",\"./files\",\"./file-type\"],function(t,e,l){\"use strict\";return e.Stats=class n{constructor(e,t,r,i,s,n,o){this.dev=0,this.ino=0,this.rdev=0,this.nlink=1,this.blksize=4096,this.uid=0,this.gid=0,this.fileData=null,this.size=t;let a=0;\"number\"!=typeof i&&(i=a=Date.now()),\"number\"!=typeof s&&(s=a=a||Date.now()),\"number\"!=typeof n&&(n=a=a||Date.now()),\"number\"!=typeof o&&(o=a=a||Date.now()),this.atimeMs=i,this.ctimeMs=n,this.mtimeMs=s,this.birthtimeMs=o,r?this.mode=r:e===l.FILE?this.mode=420:(l.DIRECTORY,this.mode=511),this.blocks=Math.ceil(t/512),this.mode<4096&&(this.mode|=e)}static fromBuffer(e){var t=e.readUInt32LE(0),r=e.readUInt32LE(4),i=e.readDoubleLE(8),s=e.readDoubleLE(16),e=e.readDoubleLE(24);return new n(61440&r,t,4095&r,i,s,e)}static clone(e){return new n(61440&e.mode,e.size,4095&e.mode,e.atimeMs,e.mtimeMs,e.ctimeMs,e.birthtimeMs)}get atime(){return new Date(this.atimeMs)}get mtime(){return new Date(this.mtimeMs)}get ctime(){return new Date(this.ctimeMs)}get birthtime(){return new Date(this.birthtimeMs)}toBuffer(){var e=t.alloc(32);return e.writeUInt32LE(this.size,0),e.writeUInt32LE(this.mode,4),e.writeDoubleLE(this.atime.getTime(),8),e.writeDoubleLE(this.mtime.getTime(),16),e.writeDoubleLE(this.ctime.getTime(),24),e}isFile(){return(61440&this.mode)===l.FILE}isDirectory(){return(61440&this.mode)===l.DIRECTORY}isSymbolicLink(){return(61440&this.mode)===l.SYMLINK}chmod(e){this.mode=61440&this.mode|e}isSocket(){return!1}isBlockDevice(){return!1}isCharacterDevice(){return!1}isFIFO(){return!1}}}),define(\"skylark-io-files/file-system\",[\"skylark-langx-funcs/defer\",\"skylark-langx-binary/buffer\",\"skylark-langx-paths\",\"./files\",\"./error-codes\",\"./file-error\",\"./file-flag\",\"./stats\"],function(s,f,t,e,d,u,o,r){\"use strict\";let n=function(e,t){return e};function y(e,t){if(\"function\"!=typeof e)throw new Error(\"Callback must be a function.\");const i=n(e,t);switch(t){case 1:return function(e){s(function(){return i(e)})};case 2:return function(e,t){s(function(){return i(e,t)})};case 3:return function(e,t,r){s(function(){return i(e,t,r)})};default:throw new Error(\"Invalid invocation of wrapCb.\")}}function a(e){if(e)return e;throw new u(d.EIO,\"Initialize BrowserFS with a file system using BrowserFS.initialize(filesystem)\")}function l(e,t){switch(typeof e){case\"number\":return e;case\"string\":var r=parseInt(e,8);return isNaN(r)?t:r;default:return t}}function c(e){if(e instanceof Date)return e;if(\"number\"==typeof e)return new Date(1e3*e);throw new u(d.EINVAL,\"Invalid time.\")}function h(e){if(0<=e.indexOf(\"\\0\"))throw new u(d.EINVAL,\"Path must be a string without null bytes.\");if(\"\"===e)throw new u(d.EINVAL,\"Path must not be empty.\");return t.resolve(e)}function p(e,t,r,i){switch(null===e?\"null\":typeof e){case\"object\":return{encoding:void 0!==e.encoding?e.encoding:t,flag:void 0!==e.flag?e.flag:r,mode:l(e.mode,i)};case\"string\":return{encoding:e,flag:r,mode:i};case\"null\":case\"undefined\":case\"function\":return{encoding:t,flag:r,mode:i};default:throw new TypeError(`\"options\" must be a string or an object, got ${typeof e} instead.`)}}function w(){}return e.FileSystem=class{constructor(){this.F_OK=0,this.R_OK=4,this.W_OK=2,this.X_OK=1,this.root=null,this.fdMap={},this.nextFd=100}initialize(e){if(e.constructor.isAvailable())return this.root=e;throw new u(d.EINVAL,\"Tried to instantiate BrowserFS with an unavailable file system.\")}_toUnixTimestamp(e){if(\"number\"==typeof e)return e;if(e instanceof Date)return e.getTime()/1e3;throw new Error(\"Cannot parse time: \"+e)}getRootFS(){return this.root||null}rename(e,t,r=w){r=y(r,1);try{a(this.root).rename(h(e),h(t),r)}catch(e){r(e)}}renameSync(e,t){a(this.root).renameSync(h(e),h(t))}exists(e,t=w){t=y(t,1);try{return a(this.root).exists(h(e),t)}catch(e){return t(!1)}}existsSync(e){try{return a(this.root).existsSync(h(e))}catch(e){return!1}}stat(e,t=w){t=y(t,2);try{return a(this.root).stat(h(e),!1,t)}catch(e){return t(e)}}statSync(e){return a(this.root).statSync(h(e),!1)}lstat(e,t=w){t=y(t,2);try{return a(this.root).stat(h(e),!0,t)}catch(e){return t(e)}}lstatSync(e){return a(this.root).statSync(h(e),!0)}truncate(e,t=0,r=w){let i=0;\"function\"==typeof t?r=t:\"number\"==typeof t&&(i=t);t=y(r,1);try{if(i<0)throw new u(d.EINVAL);return a(this.root).truncate(h(e),i,t)}catch(e){return t(e)}}truncateSync(e,t=0){if(t<0)throw new u(d.EINVAL);return a(this.root).truncateSync(h(e),t)}unlink(e,t=w){t=y(t,1);try{return a(this.root).unlink(h(e),t)}catch(e){return t(e)}}unlinkSync(e){return a(this.root).unlinkSync(h(e))}open(e,t,r,i=w){var s=l(r,420);const n=y(i=\"function\"==typeof r?r:i,2);try{a(this.root).open(h(e),o.getFileFlag(t),s,(e,t)=>{t?n(e,this.getFdForFile(t)):n(e)})}catch(e){n(e)}}openSync(e,t,r=420){return this.getFdForFile(a(this.root).openSync(h(e),o.getFileFlag(t),l(r,420)))}readFile(e,t={},r=w){var i=p(t,null,\"r\",null),t=y(r=\"function\"==typeof t?t:r,2);try{var s=o.getFileFlag(i.flag);return s.isReadable()?a(this.root).readFile(h(e),i.encoding,s,t):t(new u(d.EINVAL,\"Flag passed to readFile must allow for reading.\"))}catch(e){return t(e)}}readFileSync(e,t={}){var t=p(t,null,\"r\",null),r=o.getFileFlag(t.flag);if(r.isReadable())return a(this.root).readFileSync(h(e),t.encoding,r);throw new u(d.EINVAL,\"Flag passed to readFile must allow for reading.\")}writeFile(e,t,r={},i=w){var s=p(r,\"utf8\",\"w\",420),r=y(i=\"function\"==typeof r?r:i,1);try{var n=o.getFileFlag(s.flag);return n.isWriteable()?a(this.root).writeFile(h(e),t,s.encoding,n,s.mode,r):r(new u(d.EINVAL,\"Flag passed to writeFile must allow for writing.\"))}catch(e){return r(e)}}writeFileSync(e,t,r){var r=p(r,\"utf8\",\"w\",420),i=o.getFileFlag(r.flag);if(i.isWriteable())return a(this.root).writeFileSync(h(e),t,r.encoding,i,r.mode);throw new u(d.EINVAL,\"Flag passed to writeFile must allow for writing.\")}appendFile(e,t,r,i=w){var s=p(r,\"utf8\",\"a\",420),r=y(i=\"function\"==typeof r?r:i,1);try{var n=o.getFileFlag(s.flag);if(!n.isAppendable())return r(new u(d.EINVAL,\"Flag passed to appendFile must allow for appending.\"));a(this.root).appendFile(h(e),t,s.encoding,n,s.mode,r)}catch(e){r(e)}}appendFileSync(e,t,r){var r=p(r,\"utf8\",\"a\",420),i=o.getFileFlag(r.flag);if(i.isAppendable())return a(this.root).appendFileSync(h(e),t,r.encoding,i,r.mode);throw new u(d.EINVAL,\"Flag passed to appendFile must allow for appending.\")}fstat(e,t=w){t=y(t,2);try{this.fd2file(e).stat(t)}catch(e){t(e)}}fstatSync(e){return this.fd2file(e).statSync()}close(t,e=w){const r=y(e,1);try{this.fd2file(t).close(e=>{e||this.closeFd(t),r(e)})}catch(e){r(e)}}closeSync(e){this.fd2file(e).closeSync(),this.closeFd(e)}ftruncate(e,t,r=w){var i=\"number\"==typeof t?t:0,t=y(r=\"function\"==typeof t?t:r,1);try{var s=this.fd2file(e);if(i<0)throw new u(d.EINVAL);s.truncate(i,t)}catch(e){t(e)}}ftruncateSync(e,t=0){e=this.fd2file(e);if(t<0)throw new u(d.EINVAL);e.truncateSync(t)}fsync(e,t=w){t=y(t,1);try{this.fd2file(e).sync(t)}catch(e){t(e)}}fsyncSync(e){this.fd2file(e).syncSync()}fdatasync(e,t=w){t=y(t,1);try{this.fd2file(e).datasync(t)}catch(e){t(e)}}fdatasyncSync(e){this.fd2file(e).datasyncSync()}write(e,t,r,i,s,n=w){let o,a,l,c=null;if(\"string\"==typeof t){let e=\"utf8\";switch(typeof r){case\"function\":n=r;break;case\"number\":c=r,e=\"string\"==typeof i?i:\"utf8\",n=\"function\"==typeof s?s:n;break;default:return(n=\"function\"==typeof i?i:\"function\"==typeof s?s:n)(new u(d.EINVAL,\"Invalid arguments.\"))}o=f.from(t,e),a=0,l=o.length}else o=t,a=r,l=i,c=\"number\"==typeof s?s:null,n=\"function\"==typeof s?s:n;t=y(n,3);try{var h=this.fd2file(e);void 0!==c&&null!==c||(c=h.getPos()),h.write(o,a,l,c,t)}catch(e){t(e)}}writeSync(e,t,r,i,s){let n,o=0,a,l;\"string\"==typeof t?(l=\"number\"==typeof r?r:null,o=0,n=f.from(t,\"string\"==typeof i?i:\"utf8\"),a=n.length):(n=t,o=r,a=i,l=\"number\"==typeof s?s:null);t=this.fd2file(e);return void 0!==l&&null!==l||(l=t.getPos()),t.writeSync(n,o,a,l)}read(e,t,r,i,s,n=w){let o,a,l,c,h;if(\"number\"==typeof t){l=t,o=r;const u=i;n=\"function\"==typeof s?s:n,a=0,c=f.alloc(l),h=y((e,t,r)=>{if(e)return n(e);n(e,r.toString(u),t)},3)}else c=t,a=r,l=i,o=s,h=y(n,3);try{var d=this.fd2file(e);void 0!==o&&null!==o||(o=d.getPos()),d.read(c,a,l,o,h)}catch(e){h(e)}}readSync(e,t,r,i,s){let n=!1,o,a,l,c,h=\"utf8\";\"number\"==typeof t?(l=t,c=r,h=i,a=0,o=f.alloc(l),n=!0):(o=t,a=r,l=i,c=s);t=this.fd2file(e),void 0!==c&&null!==c||(c=t.getPos()),r=t.readSync(o,a,l,c);return n?[o.toString(h),r]:r}fchown(e,t,r,i=w){i=y(i,1);try{this.fd2file(e).chown(t,r,i)}catch(e){i(e)}}fchownSync(e,t,r){this.fd2file(e).chownSync(t,r)}fchmod(e,t,r){r=y(r,1);try{var i=\"string\"==typeof t?parseInt(t,8):t;this.fd2file(e).chmod(i,r)}catch(e){r(e)}}fchmodSync(e,t){t=\"string\"==typeof t?parseInt(t,8):t;this.fd2file(e).chmodSync(t)}futimes(e,t,r,i=w){i=y(i,1);try{var s=this.fd2file(e);\"number\"==typeof t&&(t=new Date(1e3*t)),\"number\"==typeof r&&(r=new Date(1e3*r)),s.utimes(t,r,i)}catch(e){i(e)}}futimesSync(e,t,r){this.fd2file(e).utimesSync(c(t),c(r))}rmdir(e,t=w){t=y(t,1);try{e=h(e),a(this.root).rmdir(e,t)}catch(e){t(e)}}rmdirSync(e){return e=h(e),a(this.root).rmdirSync(e)}mkdir(e,t,r=w){\"function\"==typeof t&&(r=t,t=511);r=y(r,1);try{e=h(e),a(this.root).mkdir(e,t,r)}catch(e){r(e)}}mkdirSync(e,t){a(this.root).mkdirSync(h(e),l(t,511))}readdir(e,t=w){t=y(t,2);try{e=h(e),a(this.root).readdir(e,t)}catch(e){t(e)}}readdirSync(e){return e=h(e),a(this.root).readdirSync(e)}link(e,t,r=w){r=y(r,1);try{e=h(e),t=h(t),a(this.root).link(e,t,r)}catch(e){r(e)}}linkSync(e,t){return e=h(e),t=h(t),a(this.root).linkSync(e,t)}symlink(e,t,r,i=w){var s=\"string\"==typeof r?r:\"file\",r=y(i=\"function\"==typeof r?r:i,1);try{if(\"file\"!==s&&\"dir\"!==s)return r(new u(d.EINVAL,\"Invalid type: \"+s));e=h(e),t=h(t),a(this.root).symlink(e,t,s,r)}catch(e){r(e)}}symlinkSync(e,t,r){if(r){if(\"file\"!==r&&\"dir\"!==r)throw new u(d.EINVAL,\"Invalid type: \"+r)}else r=\"file\";return e=h(e),t=h(t),a(this.root).symlinkSync(e,t,r)}readlink(e,t=w){t=y(t,2);try{e=h(e),a(this.root).readlink(e,t)}catch(e){t(e)}}readlinkSync(e){return e=h(e),a(this.root).readlinkSync(e)}chown(e,t,r,i=w){i=y(i,1);try{e=h(e),a(this.root).chown(e,!1,t,r,i)}catch(e){i(e)}}chownSync(e,t,r){e=h(e),a(this.root).chownSync(e,!1,t,r)}lchown(e,t,r,i=w){i=y(i,1);try{e=h(e),a(this.root).chown(e,!0,t,r,i)}catch(e){i(e)}}lchownSync(e,t,r){e=h(e),a(this.root).chownSync(e,!0,t,r)}chmod(e,t,r=w){r=y(r,1);try{var i=l(t,-1);if(i<0)throw new u(d.EINVAL,\"Invalid mode.\");a(this.root).chmod(h(e),!1,i,r)}catch(e){r(e)}}chmodSync(e,t){t=l(t,-1);if(t<0)throw new u(d.EINVAL,\"Invalid mode.\");e=h(e),a(this.root).chmodSync(e,!1,t)}lchmod(e,t,r=w){r=y(r,1);try{var i=l(t,-1);if(i<0)throw new u(d.EINVAL,\"Invalid mode.\");a(this.root).chmod(h(e),!0,i,r)}catch(e){r(e)}}lchmodSync(e,t){t=l(t,-1);if(t<1)throw new u(d.EINVAL,\"Invalid mode.\");a(this.root).chmodSync(h(e),!0,t)}utimes(e,t,r,i=w){i=y(i,1);try{a(this.root).utimes(h(e),c(t),c(r),i)}catch(e){i(e)}}utimesSync(e,t,r){a(this.root).utimesSync(h(e),c(t),c(r))}realpath(e,t,r=0){var i=\"object\"==typeof t?t:{},t=y(\"function\"==typeof t?t:w,2);try{e=h(e),a(this.root).realpath(e,i,t)}catch(e){t(e)}}realpathSync(e,t={}){return e=h(e),a(this.root).realpathSync(e,t)}watchFile(e,t,r=0){throw new u(d.ENOTSUP)}unwatchFile(e,t=0){throw new u(d.ENOTSUP)}watch(e,t,r=0){throw new u(d.ENOTSUP)}access(e,t,r=0){throw new u(d.ENOTSUP)}accessSync(e,t){throw new u(d.ENOTSUP)}createReadStream(e,t){throw new u(d.ENOTSUP)}createWriteStream(e,t){throw new u(d.ENOTSUP)}wrapCallbacks(e){n=e}getFdForFile(e){var t=this.nextFd++;return this.fdMap[t]=e,t}fd2file(e){e=this.fdMap[e];if(e)return e;throw new u(d.EBADF,\"Invalid file descriptor.\")}closeFd(e){delete this.fdMap[e]}}}),define(\"skylark-io-files/utils\",[\"skylark-langx-binary/buffer\",\"skylark-langx-paths\",\"./file-error\",\"./error-codes\"],function(r,s,f,y){\"use strict\";var e=\"undefined\"!=typeof navigator&&!(!/(msie) ([\\w.]+)/.exec(navigator.userAgent.toLowerCase())&&-1===navigator.userAgent.indexOf(\"Trident\")),t=\"undefined\"==typeof window;function o(e){return e instanceof Uint8Array?e:new Uint8Array(e)}function a(e){return e instanceof r?e:0===e.byteOffset&&e.byteLength===e.buffer.byteLength?i(e.buffer):r.from(e.buffer,e.byteOffset,e.byteLength)}function i(e){return r.from(e)}let n=null;function l(){return n=n||r.alloc(0)}return{deprecationMessage:function(e,t,r){e&&console.warn(`[${t}] Direct file system constructor usage is deprecated for this file system, and will be removed in the next major version. Please use the '${t}.Create(${JSON.stringify(r)}, callback)' method instead. See https://github.com/jvilk/BrowserFS/issues/176 for more details.`)},isIE:e,isWebWorker:t,fail:function(){throw new Error(\"BFS has reached an impossible code path; please file a bug.\")},mkdirpSync:function e(t,r,i){i.existsSync(t)||(e(s.dirname(t),r,i),i.mkdirSync(t,r))},buffer2ArrayBuffer:function(e){var t=(e=o(e)).byteOffset,r=e.byteLength;return 0===t&&r===e.buffer.byteLength?e.buffer:e.buffer.slice(t,t+r)},buffer2Uint8array:o,arrayish2Buffer:function(e){return e instanceof r?e:e instanceof Uint8Array?a(e):r.from(e)},uint8Array2Buffer:a,arrayBuffer2Buffer:i,copyingSlice:function(e,t=0,r=e.length){if(t<0||r<0||r>e.length||r<t)throw new TypeError(`Invalid slice bounds on buffer of length ${e.length}: [${t}, ${r}]`);var i,s,n;return 0===e.length?l():(i=o(e),s=e[0],e[0]=n=(s+1)%255,i[0]===n?(i[0]=s,a(i.slice(t,r))):(e[0]=s,a(i.subarray(t,r))))},emptyBuffer:l,bufferValidator:function(e,t){r.isBuffer(e)?t():t(new f(y.EINVAL,\"option must be a Buffer.\"))},checkOptions:function(e,t,r){const i=e.Options;var s=e.Name;let n=0,o=!1,a=!1;function l(e){o||(e&&(o=!0,r(e)),0===--n&&a&&r())}for(const u in i)if(i.hasOwnProperty(u)){var c,h=i[u],d=t[u];if(null==d){if(!h.optional)return c=Object.keys(t).filter(e=>!(e in i)).map(e=>({str:e,distance:levenshtein(u,e)})).filter(e=>e.distance<5).sort((e,t)=>e.distance-t.distance),o?void 0:(o=!0,r(new f(y.EINVAL,`[${s}] Required option '${u}' not provided.${0<c.length?` You provided unrecognized option '${c[0].str}'; perhaps you meant to type '${u}'.`:\"\"}\nOption description: `+h.description)))}else{let e=!1;if(!(e=Array.isArray(h.type)?-1!==h.type.indexOf(typeof d):typeof d===h.type))return o?void 0:(o=!0,r(new f(y.EINVAL,`[${s}] Value provided for option ${u} is not the proper type. Expected ${Array.isArray(h.type)?`one of {${h.type.join(\", \")}}`:h.type}, but received ${typeof d}\nOption description: `+h.description)));h.validator&&(n++,h.validator(d,l))}}a=!0,0!==n||o||r()}}}),define(\"skylark-io-files/preload-file\",[\"skylark-langx-binary/buffer\",\"./files\",\"./error-codes\",\"./file-error\",\"./stats\",\"./base-file\",\"./utils\"],function(n,e,o,a,r,t,i){\"use strict\";const l=i[\"emptyBuffer\"];class s extends t{constructor(e,t,r,i,s){if(super(),this._pos=0,this._dirty=!1,this._fs=e,this._path=t,this._flag=r,this._stat=i,this._buffer=s||l(),this._stat.size!==this._buffer.length&&this._flag.isReadable())throw new Error(`Invalid buffer: Buffer is ${this._buffer.length} long, yet Stats object specifies that file is ${this._stat.size} long.`)}getBuffer(){return this._buffer}getStats(){return this._stat}getFlag(){return this._flag}getPath(){return this._path}getPos(){return this._flag.isAppendable()?this._stat.size:this._pos}advancePos(e){return this._pos+=e}setPos(e){return this._pos=e}sync(t){try{this.syncSync(),t()}catch(e){t(e)}}syncSync(){throw new a(o.ENOTSUP)}close(t){try{this.closeSync(),t()}catch(e){t(e)}}closeSync(){throw new a(o.ENOTSUP)}stat(t){try{t(null,r.clone(this._stat))}catch(e){t(e)}}statSync(){return r.clone(this._stat)}truncate(e,t){try{this.truncateSync(e),this._flag.isSynchronous()&&!fs.getRootFS().supportsSynch()&&this.sync(t),t()}catch(e){return t(e)}}truncateSync(e){if(this._dirty=!0,!this._flag.isWriteable())throw new a(o.EPERM,\"File not opened with a writeable mode.\");var t;this._stat.mtimeMs=Date.now(),e>this._buffer.length?(t=n.alloc(e-this._buffer.length,0),this.writeSync(t,0,t.length,this._buffer.length)):(this._stat.size=e,t=n.alloc(e),this._buffer.copy(t,0,0,e),this._buffer=t),this._flag.isSynchronous()&&fs.getRootFS().supportsSynch()&&this.syncSync()}write(e,t,r,i,s){try{s(null,this.writeSync(e,t,r,i),e)}catch(e){s(e)}}writeSync(e,t,r,i){var s;if(this._dirty=!0,null==i&&(i=this.getPos()),this._flag.isWriteable())return(s=i+r)>this._stat.size&&(this._stat.size=s)>this._buffer.length&&(s=n.alloc(s),this._buffer.copy(s),this._buffer=s),s=e.copy(this._buffer,i,t,t+r),this._stat.mtimeMs=Date.now(),this._flag.isSynchronous()?this.syncSync():this.setPos(i+s),s;throw new a(o.EPERM,\"File not opened with a writeable mode.\")}read(e,t,r,i,s){try{s(null,this.readSync(e,t,r,i),e)}catch(e){s(e)}}readSync(e,t,r,i){if(this._flag.isReadable())return(i=null==i?this.getPos():i)+r>this._stat.size&&(r=this._stat.size-i),e=this._buffer.copy(e,t,i,i+r),this._stat.atimeMs=Date.now(),this._pos=i+r,e;throw new a(o.EPERM,\"File not opened with a readable mode.\")}chmod(e,t){try{this.chmodSync(e),t()}catch(e){t(e)}}chmodSync(e){if(!this._fs.supportsProps())throw new a(o.ENOTSUP);this._dirty=!0,this._stat.chmod(e),this.syncSync()}isDirty(){return this._dirty}resetDirty(){this._dirty=!1}}return e.PreloadFile=s}),define(\"skylark-io-files/no-sync-file\",[\"./files\",\"./preload-file\"],function(e,t){\"use strict\";class r extends t{constructor(e,t,r,i,s){super(e,t,r,i,s)}sync(e){e()}syncSync(){}close(e){e()}closeSync(){}}return e.NoSyncFile=r}),define(\"skylark-io-files/providers/registry\",[\"../files\"],function(e){var r={};return e.providers.registry={get:function(e){return r[e]},add:function(e,t){r[e]=t}}}),define(\"skylark-io-files/configure\",[\"./files\",\"./file-system\",\"./error-codes\",\"./file-error\",\"./providers/registry\"],function(e,t,i,h,d){\"use strict\";var s=e.fs=new t;return e.configure=function(e,r){!function t(e,s){const r=e.fs;if(!r)return s(new h(i.EPERM,'Missing \"fs\" property on configuration object.'));const n=e.options;let o=0;let a=!1;function l(){if(!a){a=!0;const e=d.get(r);e?e.Create(n,s):s(new h(i.EPERM,`File system ${r} is not available in BrowserFS.`))}}if(null!==n&&\"object\"==typeof n){let i=!1;const c=Object.keys(n).filter(e=>\"fs\"!==e);c.forEach(r=>{const e=n[r];null!==e&&\"object\"==typeof e&&e.fs&&(o++,t(e,function(e,t){o--,e?a||(a=!0,s(e)):(n[r]=t,0===o&&i&&l())}))}),i=!0}0===o&&l()}(e,(e,t)=>{t?(s.initialize(t),r(null,s)):r(e)})}}),define(\"skylark-io-files/providers/base-provider\",[\"skylark-langx-binary/buffer\",\"skylark-langx-paths\",\"../files\",\"../error-codes\",\"../file-error\",\"../action-type\",\"../file-flag\",\"../utils\"],function(a,o,e,l,c,h,r,t){\"use strict\";const d=t[\"fail\"];return e.providers.BaseProvider=class{supportsLinks(){return!1}diskSpace(e,t){t(0,0)}openFile(e,t,r){throw new c(l.ENOTSUP)}createFile(e,t,r,i){throw new c(l.ENOTSUP)}open(r,i,s,n){this.stat(r,!1,(e,t)=>{if(e)switch(i.pathNotExistsAction()){case h.CREATE_FILE:return this.stat(o.dirname(r),!1,(e,t)=>{e?n(e):t&&!t.isDirectory()?n(c.ENOTDIR(o.dirname(r))):this.createFile(r,i,s,n)});case h.THROW_EXCEPTION:return n(c.ENOENT(r));default:return n(new c(l.EINVAL,\"Invalid FileFlag object.\"))}else{if(t&&t.isDirectory())return n(c.EISDIR(r));switch(i.pathExistsAction()){case h.THROW_EXCEPTION:return n(c.EEXIST(r));case h.TRUNCATE_FILE:return this.openFile(r,i,(e,t)=>{e?n(e):t?t.truncate(0,()=>{t.sync(()=>{n(null,t)})}):d()});case h.NOP:return this.openFile(r,i,n);default:return n(new c(l.EINVAL,\"Invalid FileFlag object.\"))}}})}rename(e,t,r){r(new c(l.ENOTSUP))}renameSync(e,t){throw new c(l.ENOTSUP)}stat(e,t,r){r(new c(l.ENOTSUP))}statSync(e,t){throw new c(l.ENOTSUP)}openFileSync(e,t,r){throw new c(l.ENOTSUP)}createFileSync(e,t,r){throw new c(l.ENOTSUP)}openSync(t,r,i){let e;try{e=this.statSync(t,!1)}catch(e){switch(r.pathNotExistsAction()){case h.CREATE_FILE:if(this.statSync(o.dirname(t),!1).isDirectory())return this.createFileSync(t,r,i);throw c.ENOTDIR(o.dirname(t));case h.THROW_EXCEPTION:throw c.ENOENT(t);default:throw new c(l.EINVAL,\"Invalid FileFlag object.\")}}if(e.isDirectory())throw c.EISDIR(t);switch(r.pathExistsAction()){case h.THROW_EXCEPTION:throw c.EEXIST(t);case h.TRUNCATE_FILE:return this.unlinkSync(t),this.createFileSync(t,r,e.mode);case h.NOP:return this.openFileSync(t,r,i);default:throw new c(l.EINVAL,\"Invalid FileFlag object.\")}}unlink(e,t){t(new c(l.ENOTSUP))}unlinkSync(e){throw new c(l.ENOTSUP)}rmdir(e,t){t(new c(l.ENOTSUP))}rmdirSync(e){throw new c(l.ENOTSUP)}mkdir(e,t,r){r(new c(l.ENOTSUP))}mkdirSync(e,t){throw new c(l.ENOTSUP)}readdir(e,t){t(new c(l.ENOTSUP))}readdirSync(e){throw new c(l.ENOTSUP)}exists(e,t){this.stat(e,null,function(e){t(!e)})}existsSync(e){try{return this.statSync(e,!0),!0}catch(e){return!1}}realpath(t,e,r){if(this.supportsLinks()){var i=t.split(o.sep);for(let e=0;e<i.length;e++){var s=i.slice(0,e+1);i[e]=o.join.apply(null,s)}}else this.exists(t,function(e){e?r(null,t):r(c.ENOENT(t))})}realpathSync(e,t){if(this.supportsLinks()){var r=e.split(o.sep);for(let e=0;e<r.length;e++){var i=r.slice(0,e+1);r[e]=o.join.apply(path,i)}return r.join(o.sep)}if(this.existsSync(e))return e;throw c.ENOENT(e)}truncate(e,t,i){this.open(e,r.getFileFlag(\"r+\"),420,function(e,r){if(e)return i(e);r.truncate(t,function(t){r.close(function(e){i(t||e)})})})}truncateSync(e,t){e=this.openSync(e,r.getFileFlag(\"r+\"),420);try{e.truncateSync(t)}catch(e){throw e}finally{e.closeSync()}}readFile(e,s,t,n){const o=n;this.open(e,t,420,(e,i)=>{if(e)return n(e);n=function(t,r){i.close(function(e){return t=t||e,o(t,r)})},i.stat((e,t)=>{if(e)return n(e);const r=a.alloc(t.size);i.read(r,0,t.size,0,e=>{if(e)return n(e);if(null===s)return n(e,r);try{n(null,r.toString(s))}catch(e){n(e)}})})})}readFileSync(e,t,r){e=this.openSync(e,r,420);try{var i=e.statSync(),s=a.alloc(i.size);return e.readSync(s,0,i.size,0),e.closeSync(),null===t?s:s.toString(t)}finally{e.closeSync()}}writeFile(e,t,i,r,s,n){const o=n;this.open(e,r,420,function(e,r){if(e)return n(e);n=function(t){r.close(function(e){o(t||e)})};try{\"string\"==typeof t&&(t=a.from(t,i))}catch(e){return n(e)}r.write(t,0,t.length,0,n)})}writeFileSync(e,t,r,i,s){e=this.openSync(e,i,s);try{\"string\"==typeof t&&(t=a.from(t,r)),e.writeSync(t,0,t.length,0)}finally{e.closeSync()}}appendFile(e,t,i,r,s,n){const o=n;this.open(e,r,s,function(e,r){if(e)return n(e);n=function(t){r.close(function(e){o(t||e)})},\"string\"==typeof t&&(t=a.from(t,i)),r.write(t,0,t.length,null,n)})}appendFileSync(e,t,r,i,s){e=this.openSync(e,i,s);try{\"string\"==typeof t&&(t=a.from(t,r)),e.writeSync(t,0,t.length,null)}finally{e.closeSync()}}chmod(e,t,r,i){i(new c(l.ENOTSUP))}chmodSync(e,t,r){throw new c(l.ENOTSUP)}chown(e,t,r,i,s){s(new c(l.ENOTSUP))}chownSync(e,t,r,i){throw new c(l.ENOTSUP)}utimes(e,t,r,i){i(new c(l.ENOTSUP))}utimesSync(e,t,r){throw new c(l.ENOTSUP)}link(e,t,r){r(new c(l.ENOTSUP))}linkSync(e,t){throw new c(l.ENOTSUP)}symlink(e,t,r,i){i(new c(l.ENOTSUP))}symlinkSync(e,t,r){throw new c(l.ENOTSUP)}readlink(e,t){t(new c(l.ENOTSUP))}readlinkSync(e){throw new c(l.ENOTSUP)}}}),define(\"skylark-io-files/providers/dropbox/dropbox-file\",[\"../../preload-file\"],function(e){\"use strict\";class t extends e{constructor(e,t,r,i,s){super(e,t,r,i,s)}sync(e){this._fs._syncFile(this.getPath(),this.getBuffer(),e)}close(e){this.sync(e)}}return t}),define(\"skylark-io-files/providers/dropbox/dropbox-provider\",[\"skylark-langx-funcs/defer\",\"skylark-langx-binary/buffer\",\"skylark-langx-paths\",\"../../files\",\"../registry\",\"../base-provider\",\"../../stats\",\"../../file-type\",\"../../file-error\",\"../../error-codes\",\"../../utils\",\"./dropbox-file\"],function(s,o,e,t,r,i,a,l,c,h,n,d){\"use strict\";const{arrayBuffer2Buffer:u,buffer2ArrayBuffer:f}=n,y=e[\"dirname\"];function p(e){return\"/\"===e?\"\":e}function w(e){var t,r=e.error;if(!r[\".tag\"]){if(r.error)return!(t=r.error)[\".tag\"]&&t.reason&&t.reason[\".tag\"]?t.reason:t;if(\"string\"==typeof r)try{var i=JSON.parse(r);if(i.error&&i.error.reason&&i.error.reason[\".tag\"])return i.error.reason}catch(e){}}return r}function m(e){if(e.user_message)return e.user_message.text;if(e.error_summary)return e.error_summary;if(\"string\"==typeof e.error)return e.error;if(\"object\"==typeof e.error)return m(e.error);throw new Error(\"Dropbox's servers gave us a garbage error message: \"+JSON.stringify(e))}function E(e,t,r){switch(e[\".tag\"]){case\"malformed_path\":return new c(h.EBADF,r,t);case\"not_found\":return c.ENOENT(t);case\"not_file\":return c.EISDIR(t);case\"not_folder\":return c.ENOTDIR(t);case\"restricted_content\":return c.EPERM(t);default:return new c(h.EIO,r,t)}}function g(e,t,r){switch(e[\".tag\"]){case\"malformed_path\":case\"disallowed_name\":return new c(h.EBADF,r,t);case\"conflict\":case\"no_write_permission\":case\"team_folder\":return c.EPERM(t);case\"insufficient_space\":return new c(h.ENOSPC,r);default:return new c(h.EIO,r,t)}}function S(r,i,s){var e={path:p(i)};r.filesDeleteV2(e).then(()=>{s()}).catch(e=>{var t=w(e);switch(t[\".tag\"]){case\"path_lookup\":s(E(t.path_lookup,i,m(e)));break;case\"path_write\":s(g(t.path_write,i,m(e)));break;case\"too_many_write_operations\":setTimeout(()=>S(r,i,s),500+300*Math.random());break;default:s(new c(h.EIO,m(e),i))}})}class _ extends i{constructor(e){super(),this._client=e}static Create(e,t){t(null,new _(e.client))}static isAvailable(){return\"undefined\"!=typeof Dropbox}getName(){return _.Name}isReadOnly(){return!1}supportsSymlinks(){return!1}supportsProps(){return!1}supportsSynch(){return!1}empty(i){this.readdir(\"/\",(e,t)=>{if(t){const r=e=>{0===t.length?i():S(this._client,t.shift(),r)};r()}else i(e)})}rename(i,s,n){this.stat(s,!1,(e,t)=>{const r=()=>{var e={from_path:p(i),to_path:p(s)};this._client.filesMoveV2(e).then(()=>n()).catch(function(e){var t=w(e);switch(t[\".tag\"]){case\"from_lookup\":n(E(t.from_lookup,i,m(e)));break;case\"from_write\":n(g(t.from_write,i,m(e)));break;case\"to\":n(g(t.to,s,m(e)));break;case\"cant_copy_shared_folder\":case\"cant_nest_shared_folder\":n(new c(h.EPERM,m(e),i));break;case\"cant_move_folder_into_itself\":case\"duplicated_or_nested_paths\":n(new c(h.EBADF,m(e),i));break;case\"too_many_files\":n(new c(h.ENOSPC,m(e),i));break;default:n(new c(h.EIO,m(e),i))}})};e?r():i===s?e?n(c.ENOENT(s)):n():t&&t.isDirectory()?n(c.EISDIR(s)):this.unlink(s,e=>{e?n(e):r()})})}stat(r,e,i){var t;\"/\"===r?s(function(){i(null,new a(l.DIRECTORY,4096))}):(t={path:p(r)},this._client.filesGetMetadata(t).then(e=>{switch(e[\".tag\"]){case\"file\":i(null,new a(l.FILE,e.size));break;case\"folder\":i(null,new a(l.DIRECTORY,4096));break;case\"deleted\":i(c.ENOENT(r))}}).catch(e=>{var t=w(e);\"path\"===t[\".tag\"]?i(E(t.path,r,m(e))):i(new c(h.EIO,m(e),r))}))}openFile(r,i,s){var e={path:p(r)};this._client.filesDownload(e).then(e=>{e=e.fileBlob;const t=new FileReader;t.onload=()=>{var e=t.result;s(null,new d(this,r,i,new a(l.FILE,e.byteLength),u(e)))},t.readAsArrayBuffer(e)}).catch(e=>{var t=w(e);\"path\"===t[\".tag\"]?s(E(t.path,r,m(e))):s(new c(h.EIO,m(e),r))})}createFile(r,i,s,n){const t=o.alloc(0);var e={contents:new Blob([f(t)],{type:\"octet/stream\"}),path:p(r)};this._client.filesUpload(e).then(e=>{n(null,new d(this,r,i,new a(l.FILE,0),t))}).catch(e=>{var t=w(e);switch(t[\".tag\"]){case\"path\":n(g(t.path.reason,r,m(e)));break;case\"too_many_write_operations\":setTimeout(()=>this.createFile(r,i,s,n),500+300*Math.random());break;default:n(new c(h.EIO,m(e),r))}})}unlink(r,i){this.stat(r,!1,(e,t)=>{t?t.isDirectory()?i(c.EISDIR(r)):S(this._client,r,i):i(e)})}rmdir(r,i){this.readdir(r,(e,t)=>{t?0<t.length?i(c.ENOTEMPTY(r)):S(this._client,r,i):i(e)})}mkdir(r,i,s){const n=y(r);this.stat(n,!1,(e,t)=>{e?s(e):t&&!t.isDirectory()?s(c.ENOTDIR(n)):(e={path:p(r)},this._client.filesCreateFolderV2(e).then(()=>s()).catch(e=>{\"too_many_write_operations\"===w(e)[\".tag\"]?setTimeout(()=>this.mkdir(r,i,s),500+300*Math.random()):s(g(w(e).path,r,m(e)))}))})}readdir(t,r){var e={path:p(t)};this._client.filesListFolder(e).then(e=>{!function t(r,i,e,s,n){const o=e.entries.map(e=>e.path_display).filter(e=>!!e);const a=s.concat(o);if(e.has_more){const l={cursor:e.cursor};r.filesListFolderContinue(l).then(e=>{t(r,i,e,a,n)}).catch(e=>{k(e,i,n)})}else n(null,a)}(this._client,t,e,[],r)}).catch(e=>{k(e,t,r)})}_syncFile(r,i,s){var e={contents:new Blob([f(i)],{type:\"octet/stream\"}),path:p(r),mode:{\".tag\":\"overwrite\"}};this._client.filesUpload(e).then(()=>{s()}).catch(e=>{var t=w(e);switch(t[\".tag\"]){case\"path\":s(g(t.path.reason,r,m(e)));break;case\"too_many_write_operations\":setTimeout(()=>this._syncFile(r,i,s),500+300*Math.random());break;default:s(new c(h.EIO,m(e),r))}})}}function k(e,t,r){var i=w(e);\"path\"===i[\".tag\"]?r(E(i.path,t,m(e))):r(new c(h.EIO,m(e),t))}return _.Name=\"DropboxV2\",_.Options={client:{type:\"object\",description:\"An *authenticated* Dropbox client. Must be from the 2.5.x JS SDK.\"}},_.DropboxFile=d,r.add(\"dropbox\",_),t.providers.DropboxProvider=_}),define(\"skylark-io-files/providers/html5/html5-lfs-file\",[\"../../utils\",\"../../preload-file\"],function(e,t){\"use strict\";const s=e[\"buffer2ArrayBuffer\"];class r extends t{constructor(e,t,r,i,s,n){super(e,r,i,s,n),this._entry=t}sync(i){if(!this.isDirty())return i();this._entry.createWriter(t=>{var e=this.getBuffer(),e=new Blob([s(e)]);const r=e.size;t.onwriteend=e=>{t.onwriteend=null,t.onerror=null,t.truncate(r),this.resetDirty(),i()},t.onerror=e=>{i(convertError(e,this.getPath(),!1))},t.write(e)})}close(e){this.sync(e)}}return r}),define(\"skylark-io-files/providers/html5/html5-lfs-provider\",[\"skylark-langx-async\",\"skylark-langx-paths\",\"../../files\",\"../registry\",\"../../preload-file\",\"../base-provider\",\"../../error-codes\",\"../../file-error\",\"../../action-type\",\"../../stats\",\"../../file-type\",\"../../utils\",\"./html5-lfs-file\"],function(e,c,t,r,i,s,h,d,l,o,a,n,u){\"use strict\";const f=e.each,y=n[\"arrayBuffer2Buffer\"];const p=window.webkitRequestProvider||window.requestProvider||null;function w(e,t,r){switch(e.name){case\"PathExistsError\":return d.EEXIST(t);case\"QuotaExceededError\":return d.FileError(h.ENOSPC,t);case\"NotFoundError\":return d.ENOENT(t);case\"SecurityError\":return d.FileError(h.EACCES,t);case\"InvalidModificationError\":return d.FileError(h.EPERM,t);case\"TypeMismatchError\":return d.FileError(r?h.ENOTDIR:h.EISDIR,t);default:return d.FileError(h.EINVAL,t)}}class m extends s{constructor(e=5,t=window.PERSISTENT){super(),this.size=1048576*e,this.type=t}static Create(e,t){const r=new m(e.size,e.type);r._allocate(e=>e?t(e):t(null,r))}static isAvailable(){return!!p}getName(){return m.Name}isReadOnly(){return!1}supportsSymlinks(){return!1}supportsProps(){return!1}supportsSynch(){return!1}empty(r){this._readdir(\"/\",(t,e)=>{t?r(t):f(e,(t,r)=>{var e=()=>{r()},i=e=>{r(w(e,t.fullPath,!t.isDirectory))};t.isDirectory?t.removeRecursively(e,i):t.remove(e,i)},e=>{t?r(t):r()})})}rename(i,s,n){let t=2,e=0;const o=this.fs.root;let a=i;const l=e=>{--t<=0&&n(w(e,a,!1))};var r=r=>2==++e?n(new d(h.EINVAL,\"Something was identified as both a file and a directory. This should never happen.\")):i===s?n():(a=c.dirname(s),void o.getDirectory(a,{},e=>{a=c.basename(s),r.moveTo(e,a,e=>{n()},t=>{r.isDirectory?(a=s,this.unlink(s,e=>{e?l(t):this.rename(i,s,n)})):l(t)})},l));o.getFile(i,{},r,l),o.getDirectory(i,{},r,l)}stat(t,e,r){const i={create:!1};const s=e=>{var t=new o(a.DIRECTORY,4096);r(null,t)},n=e=>{r(w(e,t,!1))};this.fs.root.getFile(t,i,e=>{e.file(e=>{e=new o(a.FILE,e.size);r(null,e)},n)},()=>{this.fs.root.getDirectory(t,i,s,n)})}open(n,o,e,a){const t=e=>{\"InvalidModificationError\"===e.name&&o.isExclusive()?a(d.EEXIST(n)):a(w(e,n,!1))};this.fs.root.getFile(n,{create:o.pathNotExistsAction()===l.CREATE_FILE,exclusive:o.isExclusive()},s=>{s.file(r=>{const i=new FileReader;i.onloadend=e=>{var t=this._makeFile(n,s,o,r,i.result);a(null,t)},i.onerror=e=>{t(i.error)},i.readAsArrayBuffer(r)},t)},t)}unlink(e,t){this._remove(e,t,!0)}rmdir(r,i){this.readdir(r,(e,t)=>{e?i(e):0<t.length?i(d.ENOTEMPTY(r)):this._remove(r,i,!1)})}mkdir(t,e,r){this.fs.root.getDirectory(t,{create:!0,exclusive:!0},e=>{r()},e=>{r(w(e,t,!0))})}readdir(e,s){this._readdir(e,(e,t)=>{if(!t)return s(e);var r=[];for(const i of t)r.push(i.name);s(null,r)})}_makeFile(e,t,r,i,s=new ArrayBuffer(0)){i=new o(a.FILE,i.size),s=y(s);return new u(this,t,e,r,i,s)}_readdir(t,s){const n=e=>{s(w(e,t,!0))};this.fs.root.getDirectory(t,{create:!1},e=>{const t=e.createReader();let r=[];const i=()=>{t.readEntries(e=>{e.length?(r=r.concat(Array.prototype.slice.call(e||[],0)),i()):s(null,r)},n)};i()},n)}_allocate(t){const r=e=>{this.fs=e,t()},i=e=>{t(w(e,\"/\",!0))};if(this.type===window.PERSISTENT){var e=this.type,s=this.size,n=e=>{p(this.type,e,r,i)},o=i;if(void 0!==navigator.webkitPersistentStorage)switch(e){case window.PERSISTENT:navigator.webkitPersistentStorage.requestQuota(s,n,o);break;case window.TEMPORARY:navigator.webkitTemporaryStorage.requestQuota(s,n,o);break;default:o(new TypeError(\"Invalid storage type: \"+e))}else window.webkitStorageInfo.requestQuota(e,s,n,o)}else p(this.type,this.size,r,i)}_remove(t,r,i){var e=e=>{e.remove(()=>{r()},e=>{r(w(e,t,!i))})},s=e=>{r(w(e,t,!i))},n={create:!1};i?this.fs.root.getFile(t,n,e,s):this.fs.root.getDirectory(t,n,e,s)}}return m.Name=\"Html5LfsProvider\",m.Options={size:{type:\"number\",optional:!0,description:\"Storage quota to request, in megabytes. Allocated value may be less. Defaults to 5.\"},type:{type:\"number\",optional:!0,description:\"window.PERSISTENT or window.TEMPORARY. Defaults to PERSISTENT.\"}},m.Html5LfsFile=u,r.add(\"html5Lfs\",m),m}),define(\"skylark-io-files/providers/http/xhr\",[\"skylark-langx-binary/buffer\",\"../../error-codes\",\"../../file-error\",\"../../utils\"],function(o,a,l,e){\"use strict\";const{isIE:t,emptyBuffer:n}=e;function i(e,t,r){const i=new XMLHttpRequest;i.open(\"HEAD\",t,e),i.onreadystatechange=function(e){if(4===i.readyState){if(200!==i.status)return r(new l(a.EIO,\"XHR HEAD error: response returned code \"+i.status));try{return r(null,parseInt(i.getResponseHeader(\"Content-Length\")||\"-1\",10))}catch(e){return r(new l(a.EIO,\"XHR HEAD error: Could not read content-length.\"))}}},i.send()}return{xhrIsAvailable:\"undefined\"!=typeof XMLHttpRequest&&null!==XMLHttpRequest,asyncDownloadFile:function(e,t,r){const i=new XMLHttpRequest;i.open(\"GET\",e,!0);let s=!0;switch(t){case\"buffer\":i.responseType=\"arraybuffer\";break;case\"json\":try{i.responseType=\"json\",s=\"json\"===i.responseType}catch(e){s=!1}break;default:return r(new l(a.EINVAL,\"Invalid download type: \"+t))}i.onreadystatechange=function(e){if(4===i.readyState){if(200!==i.status)return r(new l(a.EIO,\"XHR error: response returned code \"+i.status));switch(t){case\"buffer\":return r(null,i.response?o.from(i.response):n());case\"json\":return s?r(null,i.response):r(null,JSON.parse(i.responseText))}}},i.send()},syncDownloadFile:t&&\"undefined\"!=typeof Blob?function(e,t){const r=new XMLHttpRequest;switch(r.open(\"GET\",e,!1),t){case\"buffer\":r.responseType=\"arraybuffer\";break;case\"json\":break;default:throw new l(a.EINVAL,\"Invalid download type: \"+t)}let i,s;if(r.onreadystatechange=function(e){if(4===r.readyState)if(200===r.status)switch(t){case\"buffer\":i=o.from(r.response);break;case\"json\":i=JSON.parse(r.response)}else s=new l(a.EIO,\"XHR error: response returned code \"+r.status)},r.send(),s)throw s;return i}:function(e,r){const i=new XMLHttpRequest;i.open(\"GET\",e,!1);let s=null,n=null;if(i.overrideMimeType(\"text/plain; charset=x-user-defined\"),i.onreadystatechange=function(e){if(4===i.readyState)if(200===i.status)switch(r){case\"buffer\":var t=i.responseText;s=o.alloc(t.length);for(let e=0;e<t.length;e++)s[e]=t.charCodeAt(e);return;case\"json\":return void(s=JSON.parse(i.responseText))}else n=new l(a.EIO,\"XHR error: response returned code \"+i.status)},i.send(),n)throw n;return s},getFileSizeSync:function(e){let r=-1;return i(!1,e,function(e,t){if(e)throw e;r=t}),r},getFileSizeAsync:function(e,t){i(!0,e,t)}}}),define(\"skylark-io-files/providers/http/fetch\",[\"skylark-langx-binary/buffer\",\"../../error-codes\",\"../../file-error\"],function(s,n,o){\"use strict\";return{fetchIsAvailable:\"undefined\"!=typeof fetch&&null!==fetch,fetchFileAsync:function(e,t,r){let i;try{i=fetch(e)}catch(e){return r(new o(n.EINVAL,e.message))}i.then(e=>{if(!e.ok)return r(new o(n.EIO,\"fetch error: response returned code \"+e.status));switch(t){case\"buffer\":e.arrayBuffer().then(e=>r(null,s.from(e))).catch(e=>r(new o(n.EIO,e.message)));break;case\"json\":e.json().then(e=>r(null,e)).catch(e=>r(new o(n.EIO,e.message)));break;default:r(new o(n.EINVAL,\"Invalid download type: \"+t))}}).catch(e=>r(new o(n.EIO,e.message)))},fetchFileSizeAsync:function(e,t){fetch(e,{method:\"HEAD\"}).then(e=>e.ok?t(null,parseInt(e.headers.get(\"Content-Length\")||\"-1\",10)):t(new o(n.EIO,\"fetch HEAD error: response returned code \"+e.status))).catch(e=>t(new o(n.EIO,e.message)))}}}),define(\"skylark-io-files/inodes/dir-inode\",[\"skylark-langx-paths\",\"../stats\",\"../file-type\"],function(e,t,r){\"use strict\";class i{constructor(e=null){this.data=e,this._ls={}}isFile(){return!1}isDir(){return!0}getData(){return this.data}getStats(){return new t(r.DIRECTORY,4096,365)}getListing(){return Object.keys(this._ls)}getItem(e){e=this._ls[e];return e||null}addItem(e,t){return!(e in this._ls||(this._ls[e]=t,0))}remItem(e){var t=this._ls[e];return void 0===t?null:(delete this._ls[e],t)}}return i.isDirInode=function(e){return!!e&&e.isDir()},i}),define(\"skylark-io-files/inodes/file-inode\",[],function(){\"use strict\";class e{constructor(e){this.data=e}isFile(){return!0}isDir(){return!1}getData(){return this.data}setData(e){this.data=e}}return e.isFileInode=function(e){return!!e&&e.isFile()},e}),define(\"skylark-io-files/inodes/file-index\",[\"skylark-langx-paths\",\"../stats\",\"../file-type\",\"./dir-inode\",\"./file-inode\"],function(r,d,u,f,y){\"use strict\";return class p{constructor(){this._index={},this.addPath(\"/\",new f)}static fromListing(e){for(var t=new p,r=new f,i=[[\"\",e,t._index[\"/\"]=r]];0<i.length;){let e;var s,n,o=i.pop(),a=o[0],l=o[1],c=o[2];for(const h in l)l.hasOwnProperty(h)&&(s=l[h],n=a+\"/\"+h,s?(t._index[n]=e=new f,i.push([n,s,e])):e=new y(new d(u.FILE,-1,365)),c)&&(c._ls[h]=e)}return t}fileIterator(e){for(const i in this._index)if(this._index.hasOwnProperty(i)){var t=this._index[i];for(const s of t.getListing()){var r=t.getItem(s);y.isFileInode(r)&&e(r.getData())}}}addPath(e,t){if(!t)throw new Error(\"Inode must be specified\");if(\"/\"!==e[0])throw new Error(\"Path must be absolute, got: \"+e);if(this._index.hasOwnProperty(e))return this._index[e]===t;var r=(i=this._split_path(e))[0],i=i[1];let s=this._index[r];return!(void 0===s&&\"/\"!==e&&(s=new f,!this.addPath(r,s))||\"/\"!==e&&!s.addItem(i,t)||(f.isDirInode(t)&&(this._index[e]=t),0))}addPathFast(e,t){var r=0===(i=e.lastIndexOf(\"/\"))?\"/\":e.substring(0,i),i=e.substring(i+1);let s=this._index[r];return void 0===s&&(s=new f,this.addPathFast(r,s)),!!s.addItem(i,t)&&(t.isDir()&&(this._index[e]=t),!0)}removePath(e){var t=(r=this._split_path(e))[0],r=r[1];if(void 0===(t=this._index[t]))return null;if(null===(t=t.remItem(r)))return null;if(f.isDirInode(t)){for(const i of t.getListing())this.removePath(e+\"/\"+i);\"/\"!==e&&delete this._index[e]}return t}ls(e){return void 0===(e=this._index[e])?null:e.getListing()}getInode(e){var t=(r=this._split_path(e))[0],r=r[1],i=this._index[t];return void 0===i?null:t===e?i:i.getItem(r)}_split_path(e){var t=r.dirname(e);return[t,e.substr(t.length+(\"/\"===t?0:1))]}}}),define(\"skylark-io-files/providers/http/http-provider\",[\"skylark-langx-async\",\"skylark-langx-paths\",\"../../files\",\"../registry\",\"../../no-sync-file\",\"../base-provider\",\"../../error-codes\",\"../../file-error\",\"../../action-type\",\"../../stats\",\"../../file-type\",\"../../utils\",\"./xhr\",\"./fetch\",\"../../inodes/dir-inode\",\"../../inodes/file-index\",\"../../inodes/file-inode\"],function(e,t,r,i,a,s,l,c,h,d,n,o,u,f,y,p,w){\"use strict\";const m=o[\"copyingSlice\"],{xhrIsAvailable:E,asyncDownloadFile:g,syncDownloadFile:S,getFileSizeAsync:_,getFileSizeSync:k}=u,{fetchIsAvailable:b,fetchFileAsync:v,fetchFileSizeAsync:N}=f,I=w.isFileInode,O=y.isDirInode;function T(){throw new c(l.ENOTSUP,\"Synchronous HTTP download methods are not available in this environment.\")}class F extends s{constructor(e,t=\"\",r=!1){super(),0<t.length&&\"/\"!==t.charAt(t.length-1)&&(t+=\"/\"),this.prefixUrl=t,this._index=p.fromListing(e),!b||r&&E?(this._requestFileAsyncInternal=g,this._requestFileSizeAsyncInternal=_):(this._requestFileAsyncInternal=v,this._requestFileSizeAsyncInternal=N),E?(this._requestFileSyncInternal=S,this._requestFileSizeSyncInternal=k):(this._requestFileSyncInternal=T,this._requestFileSizeSyncInternal=T)}static Create(r,i){void 0===r.index&&(r.index=\"index.json\"),\"string\"==typeof r.index?g(r.index,\"json\",(e,t)=>{e?i(e):i(null,new F(t,r.baseUrl))}):i(null,new F(r.index,r.baseUrl))}static isAvailable(){return E||b}empty(){this._index.fileIterator(function(e){e.fileData=null})}getName(){return F.Name}diskSpace(e,t){t(0,0)}isReadOnly(){return!0}supportsLinks(){return!1}supportsProps(){return!1}supportsSynch(){return E}preloadFile(e,t){var r=this._index.getInode(e);if(!I(r))throw c.EISDIR(e);if(null===r)throw c.ENOENT(e);e=r.getData();e.size=t.length,e.fileData=t}stat(e,t,r){var i=this._index.getInode(e);if(null===i)return r(c.ENOENT(e));let s;I(i)?(s=i.getData()).size<0?this._requestFileSizeAsync(e,function(e,t){if(e)return r(e);s.size=t,r(null,d.clone(s))}):r(null,d.clone(s)):O(i)?(s=i.getStats(),r(null,s)):r(c.FileError(l.EINVAL,e))}statSync(e,t){var r=this._index.getInode(e);if(null===r)throw c.ENOENT(e);let i;if(I(r))(i=r.getData()).size<0&&(i.size=this._requestFileSizeSync(e));else{if(!O(r))throw c.FileError(l.EINVAL,e);i=r.getStats()}return i}open(r,i,e,s){if(i.isWriteable())return s(new c(l.EPERM,r));const n=this;var t=this._index.getInode(r);if(null===t)return s(c.ENOENT(r));if(!I(t))return s(c.EISDIR(r));{const o=t.getData();switch(i.pathExistsAction()){case h.THROW_EXCEPTION:case h.TRUNCATE_FILE:return s(c.EEXIST(r));case h.NOP:if(o.fileData)return s(null,new a(n,r,i,d.clone(o),o.fileData));this._requestFileAsync(r,\"buffer\",function(e,t){return e?s(e):(o.size=t.length,o.fileData=t,s(null,new a(n,r,i,d.clone(o),t)))});break;default:return s(new c(l.EINVAL,\"Invalid FileMode object.\"))}}}openSync(e,t,r){if(t.isWriteable())throw new c(l.EPERM,e);var i=this._index.getInode(e);if(null===i)throw c.ENOENT(e);if(!I(i))throw c.EISDIR(e);var s,n=i.getData();switch(t.pathExistsAction()){case h.THROW_EXCEPTION:case h.TRUNCATE_FILE:throw c.EEXIST(e);case h.NOP:return n.fileData?new a(this,e,t,d.clone(n),n.fileData):(s=this._requestFileSync(e,\"buffer\"),n.size=s.length,n.fileData=s,new a(this,e,t,d.clone(n),s));default:throw new c(l.EINVAL,\"Invalid FileMode object.\")}}readdir(e,t){try{t(null,this.readdirSync(e))}catch(e){t(e)}}readdirSync(e){var t=this._index.getInode(e);if(null===t)throw c.ENOENT(e);if(O(t))return t.getListing();throw c.ENOTDIR(e)}readFile(e,s,t,n){const o=n;this.open(e,t,420,function(e,i){if(e)return n(e);n=function(t,r){i.close(function(e){return t=t||e,o(t,r)})};var t=i.getBuffer();if(null===s)n(e,m(t));else{var e=t,t=s,r=n;try{r(null,e.toString(t))}catch(e){r(e)}}})}readFileSync(e,t,r){e=this.openSync(e,r,420);try{var i=e.getBuffer();return null===t?m(i):i.toString(t)}finally{e.closeSync()}}_getHTTPPath(e){return\"/\"===e.charAt(0)&&(e=e.slice(1)),this.prefixUrl+e}_requestFileAsync(e,t,r){this._requestFileAsyncInternal(this._getHTTPPath(e),t,r)}_requestFileSync(e,t){return this._requestFileSyncInternal(this._getHTTPPath(e),t)}_requestFileSizeAsync(e,t){this._requestFileSizeAsyncInternal(this._getHTTPPath(e),t)}_requestFileSizeSync(e){return this._requestFileSizeSyncInternal(this._getHTTPPath(e))}}return F.Name=\"http\",F.Options={index:{type:[\"string\",\"object\"],optional:!0,description:\"URL to a file index as a JSON file or the file index object itself, generated with the make_http_index script. Defaults to `index.json`.\"},baseUrl:{type:\"string\",optional:!0,description:\"Used as the URL prefix for fetched files. Default: Fetch files relative to the index.\"},preferXHR:{type:\"boolean\",optional:!0,description:\"Whether to prefer XmlHttpRequest or fetch for async operations if both are available. Default: false\"}},i.add(\"http\",F),r.providers.HttpProvider=F}),define(\"skylark-io-files/inodes/inode\",[\"skylark-langx-binary/buffer\",\"../stats\",\"../file-type\"],function(t,e,r){\"use strict\";return class i{constructor(e,t,r,i,s,n){this.id=e,this.size=t,this.mode=r,this.atime=i,this.mtime=s,this.ctime=n}static fromBuffer(e){if(void 0===e)throw new Error(\"NO\");return new i(e.toString(\"ascii\",30),e.readUInt32LE(0),e.readUInt16LE(4),e.readDoubleLE(6),e.readDoubleLE(14),e.readDoubleLE(22))}toStats(){return new e((61440&this.mode)===r.DIRECTORY?r.DIRECTORY:r.FILE,this.size,this.mode,this.atime,this.mtime,this.ctime)}getSize(){return 30+this.id.length}toBuffer(e=t.alloc(this.getSize())){return e.writeUInt32LE(this.size,0),e.writeUInt16LE(this.mode,4),e.writeDoubleLE(this.atime,6),e.writeDoubleLE(this.mtime,14),e.writeDoubleLE(this.ctime,22),e.write(this.id,30,this.id.length,\"ascii\"),e}update(e){let t=!1;this.size!==e.size&&(this.size=e.size,t=!0),this.mode!==e.mode&&(this.mode=e.mode,t=!0);var r=e.atime.getTime(),r=(this.atime!==r&&(this.atime=r,t=!0),e.mtime.getTime()),r=(this.mtime!==r&&(this.mtime=r,t=!0),e.ctime.getTime());return this.ctime!==r&&(this.ctime=r,t=!0),t}isFile(){return(61440&this.mode)===r.FILE}isDirectory(){return(61440&this.mode)===r.DIRECTORY}}}),define(\"skylark-io-files/providers/async-key-value-file\",[\"../files\",\"../preload-file\"],function(e,t){\"use strict\";class r extends t{constructor(e,t,r,i,s){super(e,t,r,i,s)}sync(t){this.isDirty()?this._fs._sync(this.getPath(),this.getBuffer(),this.getStats(),e=>{e||this.resetDirty(),t(e)}):t()}close(e){this.sync(e)}}return e.providers.AsyncKeyValueFile=r}),define(\"skylark-io-files/providers/async-key-value-provider\",[\"skylark-langx-strings/generate-uuid\",\"skylark-langx-binary/buffer\",\"skylark-langx-paths\",\"skylark-data-collections/lru-cache\",\"../files\",\"../error-codes\",\"../file-error\",\"../file-type\",\"../utils\",\"../inodes/inode\",\"./base-provider\",\"./async-key-value-file\"],function(o,m,E,t,e,g,S,a,r,u,i,l){\"use strict\";const c=r[\"emptyBuffer\"];let h=null;function d(e,t){if(!e)return 1;t(e)}function _(e,t,r){if(!e)return 1;t.abort(()=>{r(e)})}class s extends i{constructor(e){super(),this._cache=null,0<e&&(this._cache=new t(e))}static isAvailable(){return!0}init(e,t){this.store=e,this.makeRootDirectory(t)}getName(){return this.store.name()}isReadOnly(){return!1}supportsSymlinks(){return!1}supportsProps(){return!1}supportsSynch(){return!1}empty(t){this._cache&&this._cache.removeAll(),this.store.clear(e=>{d(e,t)&&this.makeRootDirectory(t)})}rename(o,a,l){if(this._cache){const t=this._cache,r=(this._cache=null,t.removeAll(),l);l=e=>{this._cache=t,r(e)}}const c=this.store.beginTransaction(\"readwrite\"),h=E.dirname(o),d=E.basename(o),u=E.dirname(a),f=E.basename(a),y={},p={};let w=!1;if(0===(u+\"/\").indexOf(o+\"/\"))return l(new S(g.EBUSY,h));const s=()=>{if(!w&&p.hasOwnProperty(h)&&p.hasOwnProperty(u)){const e=p[h],t=y[h],r=p[u],i=y[u];if(e[d]){const s=e[d],n=(delete e[d],()=>{r[f]=s,c.put(t.id,m.from(JSON.stringify(e)),!0,e=>{_(e,c,l)&&(h===u?c.commit(l):c.put(i.id,m.from(JSON.stringify(r)),!0,e=>{_(e,c,l)&&c.commit(l)}))})});r[f]?this.getINode(c,a,r[f],(e,t)=>{_(e,c,l)&&(t.isFile()?c.del(t.id,e=>{_(e,c,l)&&c.del(r[f],e=>{_(e,c,l)&&n()})}):c.abort(e=>{l(S.EPERM(a))}))}):n()}else l(S.ENOENT(o))}};var e=i=>{this.findINodeAndDirListing(c,i,(e,t,r)=>{e?w||(w=!0,c.abort(()=>{l(e)})):(y[i]=t,p[i]=r,s())})};e(h),h!==u&&e(u)}stat(e,t,r){var i=this.store.beginTransaction(\"readonly\");this.findINode(i,e,(e,t)=>{d(e,r)&&r(null,t.toStats())})}createFile(r,i,e,s){const t=this.store.beginTransaction(\"readwrite\"),n=c();this.commitNewFile(t,r,a.FILE,e,n,(e,t)=>{d(e,s)&&s(null,new l(this,r,i,t.toStats(),n))})}openFile(i,s,n){const t=this.store.beginTransaction(\"readonly\");this.findINode(t,i,(e,r)=>{d(e,n)&&t.get(r.id,(e,t)=>{d(e,n)&&(void 0===t?n(S.ENOENT(i)):n(null,new l(this,i,s,r.toStats(),t)))})})}unlink(e,t){this.removeEntry(e,!1,t)}rmdir(r,i){this.readdir(r,(e,t)=>{e?i(e):0<t.length?i(S.ENOTEMPTY(r)):this.removeEntry(r,!0,i)})}mkdir(e,t,r){var i=this.store.beginTransaction(\"readwrite\"),s=m.from(\"{}\");this.commitNewFile(i,e,a.DIRECTORY,t,s,r)}readdir(r,i){const s=this.store.beginTransaction(\"readonly\");this.findINode(s,r,(e,t)=>{d(e,i)&&this.getDirListing(s,r,t,(e,t)=>{d(e,i)&&i(null,Object.keys(t))})})}_sync(t,s,n,o){const a=this.store.beginTransaction(\"readwrite\");this._findINode(a,E.dirname(t),E.basename(t),(e,i)=>{_(e,a,o)&&this.getINode(a,t,i,(e,t)=>{if(_(e,a,o)){const r=t.update(n);a.put(t.id,s,!0,e=>{_(e,a,o)&&(r?a.put(i,t.toBuffer(),!0,e=>{_(e,a,o)&&a.commit(o)}):a.commit(o))})}})})}makeRootDirectory(s){const n=this.store.beginTransaction(\"readwrite\");n.get(\"/\",(e,t)=>{if(e||void 0===t){const r=(new Date).getTime(),i=new u(o(),4096,511|a.DIRECTORY,r,r,r);n.put(i.id,h=h||m.from(\"{}\"),!1,e=>{_(e,n,s)&&n.put(\"/\",i.toBuffer(),!1,e=>{e?n.abort(()=>{s(e)}):n.commit(s)})})}else n.commit(s)})}_findINode(r,i,s,n){if(this._cache){var e=this._cache.get(E.join(i,s));if(e)return n(null,e)}const o=(e,t,r)=>{e?n(e):r[s]?(e=r[s],this._cache&&this._cache.set(E.join(i,s),e),n(null,e)):n(S.ENOENT(E.resolve(i,s)))};\"/\"===i?\"\"===s?(this._cache&&this._cache.set(E.join(i,s),\"/\"),n(null,\"/\")):this.getINode(r,i,\"/\",(e,t)=>{d(e,n)&&this.getDirListing(r,i,t,(e,t)=>{o(e,0,t)})}):this.findINodeAndDirListing(r,i,o)}findINode(r,i,s){this._findINode(r,E.dirname(i),E.basename(i),(e,t)=>{d(e,s)&&this.getINode(r,i,t,s)})}getINode(e,r,t,i){e.get(t,(e,t)=>{d(e,i)&&(void 0===t?i(S.ENOENT(r)):i(null,u.fromBuffer(t)))})}getDirListing(e,r,t,i){t.isDirectory()?e.get(t.id,(e,t)=>{if(d(e,i))try{i(null,JSON.parse(t.toString()))}catch(e){i(S.ENOENT(r))}}):i(S.ENOTDIR(r))}findINodeAndDirListing(t,i,s){this.findINode(t,i,(e,r)=>{d(e,s)&&this.getDirListing(t,i,r,(e,t)=>{d(e,s)&&s(null,r,t)})})}addNewNode(e,t,r){let i=0,s;const n=()=>{5==++i?r(new S(g.EIO,\"Unable to commit data to key-value store.\")):(s=o(),e.put(s,t,!1,(e,t)=>{e||!t?n():r(null,s)}))};n()}commitNewFile(n,t,o,a,l,c){const e=E.dirname(t),h=E.basename(t),d=(new Date).getTime();if(\"/\"===t)return c(S.EEXIST(t));this.findINodeAndDirListing(n,e,(e,i,s)=>{_(e,n,c)&&(s[h]?n.abort(()=>{c(S.EEXIST(t))}):this.addNewNode(n,l,(e,t)=>{if(_(e,n,c)){const r=new u(t,l.length,a|o,d,d,d);this.addNewNode(n,r.toBuffer(),(e,t)=>{_(e,n,c)&&(s[h]=t,n.put(i.id,m.from(JSON.stringify(s)),!0,e=>{_(e,n,c)&&n.commit(e=>{_(e,n,c)&&c(null,r)})}))})}}))})}removeEntry(n,o,a){this._cache&&this._cache.remove(n);const l=this.store.beginTransaction(\"readwrite\"),e=E.dirname(n),t=E.basename(n);this.findINodeAndDirListing(l,e,(e,r,i)=>{if(_(e,l,a))if(i[t]){const s=i[t];delete i[t],this.getINode(l,n,s,(e,t)=>{_(e,l,a)&&(!o&&t.isDirectory()?l.abort(()=>{a(S.EISDIR(n))}):o&&!t.isDirectory()?l.abort(()=>{a(S.ENOTDIR(n))}):l.del(t.id,e=>{_(e,l,a)&&l.del(s,e=>{_(e,l,a)&&l.put(r.id,m.from(JSON.stringify(i)),!0,e=>{_(e,l,a)&&l.commit(a)})})}))})}else l.abort(()=>{a(S.ENOENT(n))})})}}return e.providers.AsyncKeyValueProvider=s}),define(\"skylark-io-files/providers/indexeddb/indexed-db-ro-transaction\",[\"../../file-error\",\"../../error-codes\",\"../async-key-value-provider\",\"../../utils\"],function(o,a,e,t){\"use strict\";const l=t[\"arrayBuffer2Buffer\"];function c(e,t=e.toString()){switch(e.name){case\"NotFoundError\":return new o(a.ENOENT,t);case\"QuotaExceededError\":return new o(a.ENOSPC,t);default:return new o(a.EIO,t)}}return class{constructor(e,t){this.tx=e,this.store=t}get(e,t){try{var r=this.store.get(e);r.onerror=(i=t,s=a.EIO,n=null,function(e){e.preventDefault(),i(new o(s,null!==n?n:void 0))}),r.onsuccess=e=>{e=e.target.result;t(null,void 0===e?e:l(e))}}catch(e){t(c(e))}var i,s,n}}}),define(\"skylark-io-files/providers/indexeddb/indexed-db-rw-transaction\",[\"../../file-error\",\"../../error-codes\",\"../async-key-value-provider\",\"../../utils\",\"./indexed-db-ro-transaction\"],function(s,n,e,t,r){\"use strict\";const o=t[\"buffer2ArrayBuffer\"];window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB;function a(e,t=e.toString()){switch(e.name){case\"NotFoundError\":return new s(n.ENOENT,t);case\"QuotaExceededError\":return new s(n.ENOSPC,t);default:return new s(n.EIO,t)}}function l(t,r=n.EIO,i=null){return function(e){e.preventDefault(),t(new s(r,null!==i?i:void 0))}}class i extends r{constructor(e,t){super(e,t)}put(e,t,r,i){try{var s=o(t),n=r?this.store.put(s,e):this.store.add(s,e);n.onerror=l(i),n.onsuccess=e=>{i(null,!0)}}catch(e){i(a(e))}}del(e,t){try{var r=this.store.delete(e);r.onerror=l(t),r.onsuccess=e=>{t()}}catch(e){t(a(e))}}commit(e){setTimeout(e,0)}abort(e){let t=null;try{this.tx.abort()}catch(e){t=a(e)}finally{e(t)}}}return i}),define(\"skylark-io-files/providers/indexeddb/indexed-db-store\",[\"../../file-error\",\"../../error-codes\",\"./indexed-db-ro-transaction\",\"./indexed-db-rw-transaction\"],function(s,n,i,o){\"use strict\";function r(e,t=e.toString()){switch(e.name){case\"NotFoundError\":return new s(n.ENOENT,t);case\"QuotaExceededError\":return new s(n.ENOSPC,t);default:return new s(n.EIO,t)}}function a(t,r=n.EIO,i=null){return function(e){e.preventDefault(),t(new s(r,null!==i?i:void 0))}}return class l{constructor(e,t){this.db=e,this.storeName=t}static Create(t,r){var e=indexedDB.open(t,1);e.onupgradeneeded=e=>{(e=e.target.result).objectStoreNames.contains(t)&&e.deleteObjectStore(t),e.createObjectStore(t)},e.onsuccess=e=>{r(null,new l(e.target.result,t))},e.onerror=a(r,n.EACCES)}name(){return IndexedDBProvider.Name+\" - \"+this.storeName}clear(t){try{var e=this.db.transaction(this.storeName,\"readwrite\").objectStore(this.storeName).clear();e.onsuccess=e=>{setTimeout(t,0)},e.onerror=a(t)}catch(e){t(r(e))}}beginTransaction(e=\"readonly\"){var t=this.db.transaction(this.storeName,e),r=t.objectStore(this.storeName);if(\"readwrite\"===e)return new o(t,r);if(\"readonly\"===e)return new i(t,r);throw new s(n.EINVAL,\"Invalid transaction type.\")}}}),define(\"skylark-io-files/providers/indexeddb/indexed-db-provider\",[\"../../files\",\"../../file-error\",\"../../error-codes\",\"../async-key-value-provider\",\"../registry\",\"../../utils\",\"./indexed-db-store\",\"./indexed-db-ro-transaction\",\"./indexed-db-rw-transaction\"],function(e,t,r,i,s,n,o,a,l){\"use strict\";const c=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB;class h extends i{constructor(e){super(e)}static Create(i={},s){o.Create(i.storeName||\"browserfs\",(e,t)=>{if(t){const r=new h(\"number\"==typeof i.cacheSize?i.cacheSize:100);r.init(t,e=>{e?s(e):s(null,r)})}else s(e)})}static isAvailable(){try{return void 0!==c&&null!==c.open(\"__browserfs_test__\")}catch(e){return!1}}}return h.Name=\"IndexedDB\",h.Options={storeName:{type:\"string\",optional:!0,description:\"The name of this file system. You can have multiple IndexedDB file systems operating at once, but each must have a different name.\"},cacheSize:{type:\"number\",optional:!0,description:\"The size of the inode cache. Defaults to 100. A size of 0 or below disables caching.\"}},h.IndexedDBROTransaction=a,h.IndexedDBRWTransaction=l,h.IndexedDBStore=o,s.add(\"indexedDB\",h),e.providers.IndexedDBProvider=h}),define(\"skylark-io-files/providers/synchronous-provider\",[\"skylark-langx-binary/buffer\",\"skylark-langx-paths\",\"../files\",\"../error-codes\",\"../file-error\",\"../action-type\",\"../file-flag\",\"../utils\",\"./base-provider\"],function(e,t,r,i,s,n,o,a,l){\"use strict\";var{}=a;class c extends l{supportsSynch(){return!0}rename(e,t,r){try{this.renameSync(e,t),r()}catch(e){r(e)}}stat(e,t,r){try{r(null,this.statSync(e,t))}catch(e){r(e)}}open(e,t,r,i){try{i(null,this.openSync(e,t,r))}catch(e){i(e)}}unlink(e,t){try{this.unlinkSync(e),t()}catch(e){t(e)}}rmdir(e,t){try{this.rmdirSync(e),t()}catch(e){t(e)}}mkdir(e,t,r){try{this.mkdirSync(e,t),r()}catch(e){r(e)}}readdir(e,t){try{t(null,this.readdirSync(e))}catch(e){t(e)}}chmod(e,t,r,i){try{this.chmodSync(e,t,r),i()}catch(e){i(e)}}chown(e,t,r,i,s){try{this.chownSync(e,t,r,i),s()}catch(e){s(e)}}utimes(e,t,r,i){try{this.utimesSync(e,t,r),i()}catch(e){i(e)}}link(e,t,r){try{this.linkSync(e,t),r()}catch(e){r(e)}}symlink(e,t,r,i){try{this.symlinkSync(e,t,r),i()}catch(e){i(e)}}readlink(e,t){try{t(null,this.readlinkSync(e))}catch(e){t(e)}}}return r.providers.SynchronousProvider=c}),define(\"skylark-io-files/providers/sync-key-value-provider\",[\"skylark-langx-strings/generate-uuid\",\"skylark-langx-binary/buffer\",\"skylark-langx-paths\",\"../files\",\"../error-codes\",\"../file-error\",\"./base-provider\",\"./synchronous-provider\",\"../utils\"],function(i,u,f,e,y,p,t,r,s){\"use strict\";const n=s[\"emptyBuffer\"];class o extends r{static isAvailable(){return!0}constructor(e){super(),this.store=e.store,this.makeRootDirectory()}getName(){return this.store.name()}isReadOnly(){return!1}supportsSymlinks(){return!1}supportsProps(){return!1}supportsSynch(){return!0}empty(){this.store.clear(),this.makeRootDirectory()}renameSync(e,t){var r=this.store.beginTransaction(\"readwrite\"),i=f.dirname(e),s=f.basename(e),n=f.dirname(t),o=f.basename(t),a=this.findINode(r,i),l=this.getDirListing(r,i,a);if(!l[s])throw p.ENOENT(e);var c=l[s];if(delete l[s],0===(n+\"/\").indexOf(e+\"/\"))throw new p(y.EBUSY,i);let h,d;if((d=n===i?(h=a,l):(h=this.findINode(r,n),this.getDirListing(r,n,h)))[o]){s=this.getINode(r,t,d[o]);if(!s.isFile())throw p.EPERM(t);try{r.del(s.id),r.del(d[o])}catch(e){throw r.abort(),e}}d[o]=c;try{r.put(a.id,u.from(JSON.stringify(l)),!0),r.put(h.id,u.from(JSON.stringify(d)),!0)}catch(e){throw r.abort(),e}r.commit()}statSync(e,t){return this.findINode(this.store.beginTransaction(\"readonly\"),e).toStats()}createFileSync(e,t,r){var i=this.store.beginTransaction(\"readwrite\"),s=n(),i=this.commitNewFile(i,e,FileType.FILE,r,s);return new SyncKeyValueFile(this,e,t,i.toStats(),s)}openFileSync(e,t){var r=this.store.beginTransaction(\"readonly\"),i=this.findINode(r,e),r=r.get(i.id);if(void 0===r)throw p.ENOENT(e);return new SyncKeyValueFile(this,e,t,i.toStats(),r)}unlinkSync(e){this.removeEntry(e,!1)}rmdirSync(e){if(0<this.readdirSync(e).length)throw p.ENOTEMPTY(e);this.removeEntry(e,!0)}mkdirSync(e,t){var r=this.store.beginTransaction(\"readwrite\"),i=u.from(\"{}\");this.commitNewFile(r,e,FileType.DIRECTORY,t,i)}readdirSync(e){var t=this.store.beginTransaction(\"readonly\");return Object.keys(this.getDirListing(t,e,this.findINode(t,e)))}_syncSync(e,t,r){var i=this.store.beginTransaction(\"readwrite\"),s=this._findINode(i,f.dirname(e),f.basename(e)),e=this.getINode(i,e,s),r=e.update(r);try{i.put(e.id,t,!0),r&&i.put(s,e.toBuffer(),!0)}catch(e){throw i.abort(),e}i.commit()}makeRootDirectory(){var e,t=this.store.beginTransaction(\"readwrite\");void 0===t.get(ROOT_NODE_ID)&&(e=(new Date).getTime(),e=new Inode(i(),4096,511|FileType.DIRECTORY,e,e,e),t.put(e.id,getEmptyDirNode(),!1),t.put(ROOT_NODE_ID,e.toBuffer(),!1),t.commit())}_findINode(t,r,i){var e=e=>{e=this.getDirListing(t,r,e);if(e[i])return e[i];throw p.ENOENT(f.resolve(r,i))};return\"/\"===r?\"\"===i?ROOT_NODE_ID:e(this.getINode(t,r,ROOT_NODE_ID)):e(this.getINode(t,r+f.sep+i,this._findINode(t,f.dirname(r),f.basename(r))))}findINode(e,t){return this.getINode(e,t,this._findINode(e,f.dirname(t),f.basename(t)))}getINode(e,t,r){e=e.get(r);if(void 0===e)throw p.ENOENT(t);return Inode.fromBuffer(e)}getDirListing(e,t,r){if(!r.isDirectory())throw p.ENOTDIR(t);e=e.get(r.id);if(void 0===e)throw p.ENOENT(t);return JSON.parse(e.toString())}addNewNode(e,t){for(var r;;)try{return r=i(),e.put(r,t,!1),r}catch(e){}throw new p(y.EIO,\"Unable to commit data to key-value store.\")}commitNewFile(t,e,r,i,s){var n=f.dirname(e),o=f.basename(e),a=this.findINode(t,n),n=this.getDirListing(t,n,a),l=(new Date).getTime();if(\"/\"===e)throw p.EEXIST(e);if(n[o])throw p.EEXIST(e);let c;try{var h=this.addNewNode(t,s),d=(c=new Inode(h,s.length,i|r,l,l,l),this.addNewNode(t,c.toBuffer()));n[o]=d,t.put(a.id,u.from(JSON.stringify(n)),!0)}catch(e){throw t.abort(),e}return t.commit(),c}removeEntry(e,t){var r=this.store.beginTransaction(\"readwrite\"),i=f.dirname(e),s=this.findINode(r,i),i=this.getDirListing(r,i,s),n=f.basename(e);if(!i[n])throw p.ENOENT(e);var o=i[n],n=(delete i[n],this.getINode(r,e,o));if(!t&&n.isDirectory())throw p.EISDIR(e);if(t&&!n.isDirectory())throw p.ENOTDIR(e);try{r.del(n.id),r.del(o),r.put(s.id,u.from(JSON.stringify(i)),!0)}catch(e){throw r.abort(),e}r.commit()}}return e.providers.SyncKeyValueProvider=o}),define(\"skylark-io-files/providers/simple-sync-rw-transaction\",[\"../files\",\"../error-codes\",\"../file-error\"],function(e,t,r){\"use strict\";return e.providers.SimpleSyncRWTransaction=class{constructor(e){this.store=e,this.originalData={},this.modifiedKeys=[]}get(e){var t=this.store.get(e);return this.stashOldValue(e,t),t}put(e,t,r){return this.markModified(e),this.store.put(e,t,r)}del(e){this.markModified(e),this.store.del(e)}commit(){}abort(){for(const t of this.modifiedKeys){var e=this.originalData[t];e?this.store.put(t,e,!0):this.store.del(t)}}stashOldValue(e,t){this.originalData.hasOwnProperty(e)||(this.originalData[e]=t)}markModified(e){-1===this.modifiedKeys.indexOf(e)&&(this.modifiedKeys.push(e),this.originalData.hasOwnProperty(e)||(this.originalData[e]=this.store.get(e)))}}}),define(\"skylark-io-files/providers/inmemory/in-memory-store\",[\"../simple-sync-rw-transaction\"],function(t){\"use strict\";return class{constructor(){this.store={}}clear(){this.store={}}beginTransaction(e){return new t(this)}get(e){return this.store[e]}put(e,t,r){return!(!r&&this.store.hasOwnProperty(e)||(this.store[e]=t,0))}del(e){delete this.store[e]}}}),define(\"skylark-io-files/providers/inmemory/in-memory-provider\",[\"../../files\",\"../registry\",\"../sync-key-value-provider\",\"./in-memory-store\"],function(e,t,r,i){\"use strict\";class s extends r{name(){return s.Name}constructor(){super({store:new i})}static Create(e,t){t(null,new s)}}return s.Name=\"InMemory\",s.Options={},s.InMemoryStore=i,t.add(\"inMemory\",s),e.providers.InMemoryProvider=s}),define(\"skylark-io-files/providers/localstorage/local-storage-store\",[\"skylark-langx-binary/buffer\",\"../simple-sync-rw-transaction\",\"../../error-codes\",\"../../file-error\"],function(r,t,i,s){\"use strict\";return class{name(){return LocalStorageProvider.Name}clear(){window.localStorage.clear()}beginTransaction(e){return new t(this)}get(e){try{var t=window.localStorage.getItem(e);if(null!==t)return r.from(t,binaryEncoding)}catch(e){}}put(e,t,r){try{return r||null===window.localStorage.getItem(e)?(window.localStorage.setItem(e,t.toString(binaryEncoding)),!0):!1}catch(e){throw new s(i.ENOSPC,\"LocalStorage is full.\")}}del(t){try{window.localStorage.removeItem(t)}catch(e){throw new s(i.EIO,\"Unable to delete key \"+t+\": \"+e)}}}}),define(\"skylark-io-files/providers/localstorage/local-storage-provider\",[\"skylark-langx-binary/buffer\",\"../../files\",\"../registry\",\"../sync-key-value-provider\",\"../../error-codes\",\"../../file-error\",\"./local-storage-store\"],function(e,t,r,i,s,n,o){\"use strict\";let a=!1,l;try{window.localStorage.setItem(\"__test__\",String.fromCharCode(55296)),a=window.localStorage.getItem(\"__test__\")===String.fromCharCode(55296)}catch(e){a=!1}l=a?\"binary_string\":\"binary_string_ie\",e.isEncoding(l);class c extends i{constructor(){super({store:new o})}static Create(e,t){t(null,new c)}static isAvailable(){return void 0!==window.localStorage}}return c.Name=\"LocalStorage\",c.Options={},c.LocalStorageStore=o,r.add(\"localStorage\",c),t.providers.LocalStorageProvider=c}),define(\"skylark-io-files/providers/mutex\",[\"skylark-langx-funcs/defer\"],function(t){\"use strict\";return class{constructor(){this._locked=!1,this._waiters=[]}lock(e){this._locked?this._waiters.push(e):(this._locked=!0,e())}unlock(){if(!this._locked)throw new Error(\"unlock of a non-locked mutex\");var e=this._waiters.shift();e?t(e):this._locked=!1}tryLock(){return!this._locked&&(this._locked=!0)}isLocked(){return this._locked}}}),define(\"skylark-io-files/providers/locked-provider\",[\"../files\",\"./mutex\"],function(e,t){\"use strict\";return e.providers.LockedProvider=class{constructor(e){this._fs=e,this._mu=new t}getName(){return\"LockedProvider<\"+this._fs.getName()+\">\"}getFSUnlocked(){return this._fs}diskSpace(e,t){this._fs.diskSpace(e,t)}isReadOnly(){return this._fs.isReadOnly()}supportsLinks(){return this._fs.supportsLinks()}supportsProps(){return this._fs.supportsProps()}supportsSynch(){return this._fs.supportsSynch()}rename(e,t,r){this._mu.lock(()=>{this._fs.rename(e,t,e=>{this._mu.unlock(),r(e)})})}renameSync(e,t){if(this._mu.isLocked())throw new Error(\"invalid sync call\");return this._fs.renameSync(e,t)}stat(e,t,r){this._mu.lock(()=>{this._fs.stat(e,t,(e,t)=>{this._mu.unlock(),r(e,t)})})}statSync(e,t){if(this._mu.isLocked())throw new Error(\"invalid sync call\");return this._fs.statSync(e,t)}open(e,t,r,i){this._mu.lock(()=>{this._fs.open(e,t,r,(e,t)=>{this._mu.unlock(),i(e,t)})})}openSync(e,t,r){if(this._mu.isLocked())throw new Error(\"invalid sync call\");return this._fs.openSync(e,t,r)}unlink(e,t){this._mu.lock(()=>{this._fs.unlink(e,e=>{this._mu.unlock(),t(e)})})}unlinkSync(e){if(this._mu.isLocked())throw new Error(\"invalid sync call\");return this._fs.unlinkSync(e)}rmdir(e,t){this._mu.lock(()=>{this._fs.rmdir(e,e=>{this._mu.unlock(),t(e)})})}rmdirSync(e){if(this._mu.isLocked())throw new Error(\"invalid sync call\");return this._fs.rmdirSync(e)}mkdir(e,t,r){this._mu.lock(()=>{this._fs.mkdir(e,t,e=>{this._mu.unlock(),r(e)})})}mkdirSync(e,t){if(this._mu.isLocked())throw new Error(\"invalid sync call\");return this._fs.mkdirSync(e,t)}readdir(e,r){this._mu.lock(()=>{this._fs.readdir(e,(e,t)=>{this._mu.unlock(),r(e,t)})})}readdirSync(e){if(this._mu.isLocked())throw new Error(\"invalid sync call\");return this._fs.readdirSync(e)}exists(e,t){this._mu.lock(()=>{this._fs.exists(e,e=>{this._mu.unlock(),t(e)})})}existsSync(e){if(this._mu.isLocked())throw new Error(\"invalid sync call\");return this._fs.existsSync(e)}realpath(e,t,r){this._mu.lock(()=>{this._fs.realpath(e,t,(e,t)=>{this._mu.unlock(),r(e,t)})})}realpathSync(e,t){if(this._mu.isLocked())throw new Error(\"invalid sync call\");return this._fs.realpathSync(e,t)}truncate(e,t,r){this._mu.lock(()=>{this._fs.truncate(e,t,e=>{this._mu.unlock(),r(e)})})}truncateSync(e,t){if(this._mu.isLocked())throw new Error(\"invalid sync call\");return this._fs.truncateSync(e,t)}readFile(e,t,r,i){this._mu.lock(()=>{this._fs.readFile(e,t,r,(e,t)=>{this._mu.unlock(),i(e,t)})})}readFileSync(e,t,r){if(this._mu.isLocked())throw new Error(\"invalid sync call\");return this._fs.readFileSync(e,t,r)}writeFile(e,t,r,i,s,n){this._mu.lock(()=>{this._fs.writeFile(e,t,r,i,s,e=>{this._mu.unlock(),n(e)})})}writeFileSync(e,t,r,i,s){if(this._mu.isLocked())throw new Error(\"invalid sync call\");return this._fs.writeFileSync(e,t,r,i,s)}appendFile(e,t,r,i,s,n){this._mu.lock(()=>{this._fs.appendFile(e,t,r,i,s,e=>{this._mu.unlock(),n(e)})})}appendFileSync(e,t,r,i,s){if(this._mu.isLocked())throw new Error(\"invalid sync call\");return this._fs.appendFileSync(e,t,r,i,s)}chmod(e,t,r,i){this._mu.lock(()=>{this._fs.chmod(e,t,r,e=>{this._mu.unlock(),i(e)})})}chmodSync(e,t,r){if(this._mu.isLocked())throw new Error(\"invalid sync call\");return this._fs.chmodSync(e,t,r)}chown(e,t,r,i,s){this._mu.lock(()=>{this._fs.chown(e,t,r,i,e=>{this._mu.unlock(),s(e)})})}chownSync(e,t,r,i){if(this._mu.isLocked())throw new Error(\"invalid sync call\");return this._fs.chownSync(e,t,r,i)}utimes(e,t,r,i){this._mu.lock(()=>{this._fs.utimes(e,t,r,e=>{this._mu.unlock(),i(e)})})}utimesSync(e,t,r){if(this._mu.isLocked())throw new Error(\"invalid sync call\");return this._fs.utimesSync(e,t,r)}link(e,t,r){this._mu.lock(()=>{this._fs.link(e,t,e=>{this._mu.unlock(),r(e)})})}linkSync(e,t){if(this._mu.isLocked())throw new Error(\"invalid sync call\");return this._fs.linkSync(e,t)}symlink(e,t,r,i){this._mu.lock(()=>{this._fs.symlink(e,t,r,e=>{this._mu.unlock(),i(e)})})}symlinkSync(e,t,r){if(this._mu.isLocked())throw new Error(\"invalid sync call\");return this._fs.symlinkSync(e,t,r)}readlink(e,r){this._mu.lock(()=>{this._fs.readlink(e,(e,t)=>{this._mu.unlock(),r(e,t)})})}readlinkSync(e){if(this._mu.isLocked())throw new Error(\"invalid sync call\");return this._fs.readlinkSync(e)}}}),define(\"skylark-io-files/providers/overlay/overlay-file\",[\"../../preload-file\"],function(e){class t extends e{constructor(e,t,r,i,s){super(e,t,r,i,s)}sync(t){this.isDirty()?this._fs._syncAsync(this,e=>{this.resetDirty(),t(e)}):t(null)}syncSync(){this.isDirty()&&(this._fs._syncSync(this),this.resetDirty())}close(e){this.sync(e)}closeSync(){this.syncSync()}}return t}),define(\"skylark-io-files/providers/overlay/unlocked-overlay-provider\",[\"skylark-langx-paths\",\"../base-provider\",\"../../stats\",\"../../file-type\",\"../../file-error\",\"../../error-codes\",\"../../file-flag\",\"../../action-type\",\"./overlay-file\"],function(c,e,o,t,h,d,r,a,l){const n=\"/.deletedFiles.log\";function u(e){return 146|e}function f(e){return r.getFileFlag(e)}class i extends e{constructor(e,t){if(super(),this._isInitialized=!1,this._initializeCallbacks=[],this._deletedFiles={},this._deleteLog=\"\",this._deleteLogUpdatePending=!1,this._deleteLogUpdateNeeded=!1,this._deleteLogError=null,this._writable=e,this._readable=t,this._writable.isReadOnly())throw new h(d.EINVAL,\"Writable file system must be writable.\")}static isAvailable(){return!0}getOverlayedProviders(){return{readable:this._readable,writable:this._writable}}_syncAsync(t,r){this.createParentDirectoriesAsync(t.getPath(),e=>{if(e)return r(e);this._writable.writeFile(t.getPath(),t.getBuffer(),null,f(\"w\"),t.getStats().mode,r)})}_syncSync(e){this.createParentDirectories(e.getPath()),this._writable.writeFileSync(e.getPath(),e.getBuffer(),null,f(\"w\"),e.getStats().mode)}getName(){return OverlayFS.Name}_initialize(e){const r=this._initializeCallbacks,i=t=>{this._isInitialized=!t,this._initializeCallbacks=[],r.forEach(e=>e(t))};if(this._isInitialized)return e();r.push(e),1===r.length&&this._writable.readFile(n,\"utf8\",f(\"r\"),(e,t)=>{if(e){if(e.errno!==d.ENOENT)return i(e)}else this._deleteLog=t;this._reparseDeletionLog(),i()})}isReadOnly(){return!1}supportsSynch(){return this._readable.supportsSynch()&&this._writable.supportsSynch()}supportsLinks(){return!1}supportsProps(){return this._readable.supportsProps()&&this._writable.supportsProps()}getDeletionLog(){return this._deleteLog}restoreDeletionLog(e){this._deleteLog=e,this._reparseDeletionLog(),this.updateLog(\"\")}rename(o,a,l){if(this.checkInitAsync(l)&&!this.checkPathAsync(o,l)&&!this.checkPathAsync(a,l))return o===n||a===n?l(h.EPERM(\"Cannot rename deletion log.\")):o===a?l():void this.stat(o,!1,(e,n)=>e?l(e):this.stat(a,!1,(e,t)=>{const i=this;function s(t){var e=t.shift();if(!e)return l();var r=c.resolve(o,e),e=c.resolve(a,e);i.rename(r,e,e=>{if(e)return l(e);s(t)})}let r=511;if(n.isDirectory()){if(e)return e.errno!==d.ENOENT?l(e):this._writable.exists(o,e=>{if(e)return this._writable.rename(o,a,l);this._writable.mkdir(a,r,e=>{if(e)return l(e);this._readable.readdir(o,(e,t)=>{if(e)return l();s(t)})})});if(r=t.mode,!t.isDirectory())return l(h.ENOTDIR(a));this.readdir(a,(e,t)=>{if(t&&t.length)return l(h.ENOTEMPTY(a));this._readable.readdir(o,(e,t)=>{if(e)return l();s(t)})})}if(t&&t.isDirectory())return l(h.EISDIR(a));this.readFile(o,null,f(\"r\"),(e,t)=>e?l(e):this.writeFile(a,t,null,f(\"w\"),n.mode,e=>e?l(e):this.unlink(o,l)))}))}renameSync(t,r){if(this.checkInitialized(),this.checkPath(t),this.checkPath(r),t===n||r===n)throw h.EPERM(\"Cannot rename deletion log.\");var e=this.statSync(t,!1);if(e.isDirectory()){if(t===r)return;let e=511;if(this.existsSync(r)){var i=this.statSync(r,!1);if(e=i.mode,!i.isDirectory())throw h.ENOTDIR(r);if(0<this.readdirSync(r).length)throw h.ENOTEMPTY(r)}this._writable.existsSync(t)?this._writable.renameSync(t,r):this._writable.existsSync(r)||this._writable.mkdirSync(r,e),this._readable.existsSync(t)&&this._readable.readdirSync(t).forEach(e=>{this.renameSync(c.resolve(t,e),c.resolve(r,e))})}else{if(this.existsSync(r)&&this.statSync(r,!1).isDirectory())throw h.EISDIR(r);this.writeFileSync(r,this.readFileSync(t,null,f(\"r\")),null,f(\"w\"),e.mode)}t!==r&&this.existsSync(t)&&this.unlinkSync(t)}stat(r,i,s){this.checkInitAsync(s)&&this._writable.stat(r,i,(e,t)=>{e&&e.errno===d.ENOENT?(this._deletedFiles[r]&&s(h.ENOENT(r)),this._readable.stat(r,i,(e,t)=>{t&&((t=o.clone(t)).mode=u(t.mode)),s(e,t)})):s(e,t)})}statSync(t,r){this.checkInitialized();try{return this._writable.statSync(t,r)}catch(e){if(this._deletedFiles[t])throw h.ENOENT(t);t=o.clone(this._readable.statSync(t,r));return t.mode=u(t.mode),t}}open(i,s,t,n){this.checkInitAsync(n)&&!this.checkPathAsync(i,n)&&this.stat(i,!1,(e,r)=>{if(!r)return s.pathNotExistsAction()!==a.CREATE_FILE?n(h.ENOENT(i)):this.createParentDirectoriesAsync(i,e=>e?n(e):this._writable.open(i,s,t,n));switch(s.pathExistsAction()){case a.TRUNCATE_FILE:return this.createParentDirectoriesAsync(i,e=>{if(e)return n(e);this._writable.open(i,s,t,n)});case a.NOP:return this._writable.exists(i,e=>{e?this._writable.open(i,s,t,n):((r=o.clone(r)).mode=t,this._readable.readFile(i,null,f(\"r\"),(e,t)=>{if(e)return n(e);-1===r.size&&(r.size=t.length);e=new l(this,i,s,r,t);n(null,e)}))});default:return n(h.EEXIST(i))}})}openSync(e,t,r){if(this.checkInitialized(),this.checkPath(e),e===n)throw h.EPERM(\"Cannot open deletion log.\");if(!this.existsSync(e)){if(t.pathNotExistsAction()!==a.CREATE_FILE)throw h.ENOENT(e);return this.createParentDirectories(e),this._writable.openSync(e,t,r)}switch(t.pathExistsAction()){case a.TRUNCATE_FILE:return this.createParentDirectories(e),this._writable.openSync(e,t,r);case a.NOP:var i,s;return this._writable.existsSync(e)?this._writable.openSync(e,t,r):(i=this._readable.readFileSync(e,null,f(\"r\")),(s=o.clone(this._readable.statSync(e,!1))).mode=r,new l(this,e,t,s,i));default:throw h.EEXIST(e)}}unlink(t,r){this.checkInitAsync(r)&&!this.checkPathAsync(t,r)&&this.exists(t,e=>{if(!e)return r(h.ENOENT(t));this._writable.exists(t,e=>{if(e)return this._writable.unlink(t,e=>{if(e)return r(e);this.exists(t,e=>{e&&this.deletePath(t),r(null)})});this.deletePath(t),r(null)})})}unlinkSync(e){if(this.checkInitialized(),this.checkPath(e),!this.existsSync(e))throw h.ENOENT(e);this._writable.existsSync(e)&&this._writable.unlinkSync(e),this.existsSync(e)&&this.deletePath(e)}rmdir(r,i){if(this.checkInitAsync(i)){const t=()=>{this.readdir(r,(e,t)=>e?i(e):t.length?i(h.ENOTEMPTY(r)):(this.deletePath(r),void i(null)))};this.exists(r,e=>{if(!e)return i(h.ENOENT(r));this._writable.exists(r,e=>{e?this._writable.rmdir(r,e=>{if(e)return i(e);this._readable.exists(r,e=>{(e?t:i)()})}):t()})})}}rmdirSync(e){if(this.checkInitialized(),!this.existsSync(e))throw h.ENOENT(e);if(this._writable.existsSync(e)&&this._writable.rmdirSync(e),this.existsSync(e)){if(0<this.readdirSync(e).length)throw h.ENOTEMPTY(e);this.deletePath(e)}}mkdir(t,r,i){this.checkInitAsync(i)&&this.exists(t,e=>{if(e)return i(h.EEXIST(t));this.createParentDirectoriesAsync(t,e=>{if(e)return i(e);this._writable.mkdir(t,r,i)})})}mkdirSync(e,t){if(this.checkInitialized(),this.existsSync(e))throw h.EEXIST(e);this.createParentDirectories(e),this._writable.mkdirSync(e,t)}readdir(s,n){this.checkInitAsync(n)&&this.stat(s,!1,(e,t)=>e?n(e):t.isDirectory()?void this._writable.readdir(s,(e,i)=>{if(e&&\"ENOENT\"!==e.code)return n(e);!e&&i||(i=[]),this._readable.readdir(s,(e,t)=>{const r={};e=i.concat((t=!e&&t?t:[]).filter(e=>!this._deletedFiles[s+\"/\"+e])).filter(e=>{var t=!r[e];return r[e]=!0,t});n(null,e)})}):n(h.ENOTDIR(s)))}readdirSync(t){if(this.checkInitialized(),!this.statSync(t,!1).isDirectory())throw h.ENOTDIR(t);let e=[];try{e=e.concat(this._writable.readdirSync(t))}catch(e){}try{e=e.concat(this._readable.readdirSync(t).filter(e=>!this._deletedFiles[t+\"/\"+e]))}catch(e){}const r={};return e.filter(e=>{var t=!r[e];return r[e]=!0,t})}exists(t,r){this.checkInitialized(),this._writable.exists(t,e=>{if(e)return r(!0);this._readable.exists(t,e=>{r(e&&!0!==this._deletedFiles[t])})})}existsSync(e){return this.checkInitialized(),this._writable.existsSync(e)||this._readable.existsSync(e)&&!0!==this._deletedFiles[e]}chmod(t,r,i,s){this.checkInitAsync(s)&&this.operateOnWritableAsync(t,e=>{if(e)return s(e);this._writable.chmod(t,r,i,s)})}chmodSync(e,t,r){this.checkInitialized(),this.operateOnWritable(e,()=>{this._writable.chmodSync(e,t,r)})}chown(t,r,i,s,n){this.checkInitAsync(n)&&this.operateOnWritableAsync(t,e=>{if(e)return n(e);this._writable.chown(t,r,i,s,n)})}chownSync(e,t,r,i){this.checkInitialized(),this.operateOnWritable(e,()=>{this._writable.chownSync(e,t,r,i)})}utimes(t,r,i,s){this.checkInitAsync(s)&&this.operateOnWritableAsync(t,e=>{if(e)return s(e);this._writable.utimes(t,r,i,s)})}utimesSync(e,t,r){this.checkInitialized(),this.operateOnWritable(e,()=>{this._writable.utimesSync(e,t,r)})}deletePath(e){this._deletedFiles[e]=!0,this.updateLog(`d${e}\n`)}updateLog(e){this._deleteLog+=e,this._deleteLogUpdatePending?this._deleteLogUpdateNeeded=!0:(this._deleteLogUpdatePending=!0,this._writable.writeFile(n,this._deleteLog,\"utf8\",r.getFileFlag(\"w\"),420,e=>{this._deleteLogUpdatePending=!1,e?this._deleteLogError=e:this._deleteLogUpdateNeeded&&(this._deleteLogUpdateNeeded=!1,this.updateLog(\"\"))}))}_reparseDeletionLog(){this._deletedFiles={},this._deleteLog.split(\"\\n\").forEach(e=>{this._deletedFiles[e.slice(1)]=\"d\"===e.slice(0,1)})}checkInitialized(){if(!this._isInitialized)throw new h(d.EPERM,\"OverlayProvideris not initialized. Please initialize OverlayProviderusing its initialize() method before using it.\");var e;if(null!==this._deleteLogError)throw e=this._deleteLogError,this._deleteLogError=null,e}checkInitAsync(e){var t;return this._isInitialized?null===this._deleteLogError||(t=this._deleteLogError,this._deleteLogError=null,e(t),!1):(e(new h(d.EPERM,\"OverlayProvideris not initialized. Please initialize OverlayProviderusing its initialize() method before using it.\")),!1)}checkPath(e){if(e===n)throw h.EPERM(e)}checkPathAsync(e,t){return e===n&&(t(h.EPERM(e)),!0)}createParentDirectoriesAsync(e,i){let s=c.dirname(e);const n=[],o=this;function a(){if(!n.length)return i();const r=n.pop();o._readable.stat(r,!1,(e,t)=>{if(!t)return i();o._writable.mkdir(r,t.mode,e=>{if(e)return i(e);a()})})}this._writable.stat(s,!1,function e(t,r){t?\"/\"===s?i(new h(d.EBUSY,\"Invariant failed: root does not exist!\")):(n.push(s),s=c.dirname(s),o._writable.stat(s,!1,e)):a()})}createParentDirectories(e){let t=c.dirname(e),r=[];for(;!this._writable.existsSync(t);)r.push(t),t=c.dirname(t);(r=r.reverse()).forEach(e=>{this._writable.mkdirSync(e,this.statSync(e,!1).mode)})}operateOnWritable(e,t){if(!this.existsSync(e))throw h.ENOENT(e);this._writable.existsSync(e)||this.copyToWritable(e),t()}operateOnWritableAsync(t,r){this.exists(t,e=>{if(!e)return r(h.ENOENT(t));this._writable.exists(t,e=>{if(!e)return this.copyToWritableAsync(t,r);r()})})}copyToWritable(e){var t=this.statSync(e,!1);t.isDirectory()?this._writable.mkdirSync(e,t.mode):this.writeFileSync(e,this._readable.readFileSync(e,null,f(\"r\")),null,f(\"w\"),this.statSync(e,!1).mode)}copyToWritableAsync(i,s){this.stat(i,!1,(e,r)=>e?s(e):r.isDirectory()?this._writable.mkdir(i,r.mode,s):void this._readable.readFile(i,null,f(\"r\"),(e,t)=>{if(e)return s(e);this.writeFile(i,t,null,f(\"w\"),r.mode,s)}))}}return i}),define(\"skylark-io-files/providers/overlay/overlay-provider\",[\"skylark-langx-paths\",\"../../files\",\"../registry\",\"../../stats\",\"../../file-type\",\"../../file-error\",\"../../error-codes\",\"../../file-flag\",\"../../action-type\",\"../locked-provider\",\"./unlocked-overlay-provider\"],function(e,t,r,i,s,n,o,a,l,c,h){class d extends c{constructor(e,t){super(new h(e,t))}static Create(e,t){try{const r=new d(e.writable,e.readable);r._initialize(e=>{t(e,r)})}catch(e){t(e)}}static isAvailable(){return h.isAvailable()}getOverlayedProviders(){return super.getFSUnlocked().getOverlayedProviders()}unwrap(){return super.getFSUnlocked()}_initialize(e){super.getFSUnlocked()._initialize(e)}}return d.Name=\"OverlayProvider\",d.Options={writable:{type:\"object\",description:\"The file system to write modified files to.\"},readable:{type:\"object\",description:\"The file system that initially populates this file system.\"}},r.add(\"overlay\",d),t.providers.OverlayProvider=d}),define(\"skylark-io-files/main\",[\"./files\",\"./action-type\",\"./base-file\",\"./error-codes\",\"./error-strings\",\"./file-error\",\"./file-flag\",\"./file-system\",\"./no-sync-file\",\"./preload-file\",\"./stats\",\"./configure\",\"./providers/dropbox/dropbox-provider\",\"./providers/html5/html5-lfs-provider\",\"./providers/http/http-provider\",\"./providers/indexeddb/indexed-db-provider\",\"./providers/inmemory/in-memory-provider\",\"./providers/localstorage/local-storage-provider\",\"./providers/overlay/overlay-provider\"],function(e){return e}),define(\"skylark-io-files\",[\"skylark-io-files/main\"],function(e){return e});"]}